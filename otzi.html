<!doctype html>
<html lang="fr">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ötzi — version classe stable</title>
<style>
  html,body{margin:0;height:100%;background:#0e141b;color:#e8eef6;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{display:flex;flex-direction:column;align-items:center;gap:10px;padding:16px}
  canvas{background:#93c5fd;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.35);width:960px;height:540px}
  .hud{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;font-weight:600}
  .kbd{padding:2px 6px;border-radius:6px;background:#223049;font-family:ui-monospace,Menlo,Consolas,monospace}
  button{padding:8px 12px;border-radius:10px;border:0;background:#1f6feb;color:#fff;font-weight:700;cursor:pointer}
  button.secondary{background:#2b3950}
</style>

<div class="wrap">
  <h1>Ötzi — version classe stable</h1>
  <div class="hud">
    <span>Niveau: <b id="levelName">—</b></span>
    <span>Temps: <b id="time">—</b>s</span>
    <span>Pierre: <b id="stone">0</b></span>
    <span>Bois: <b id="wood">0</b></span>
    <span>Javelots: <b id="spears">3</b></span>
    <span>Vies: <b id="lives">3</b></span>
    <button id="btnStart">Lancer / Rejouer</button>
    <button id="btnPause" class="secondary">P: Pause</button>
  </div>
  <div>Commandes : <span class="kbd">← → ↑ ↓</span> / <span class="kbd">W A S D</span> • <span class="kbd">Espace</span> javelot • <span class="kbd">Entrée</span> narration.</div>
  <canvas id="game" width="960" height="540"></canvas>
</div>

<script>
const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
const UI=id=>document.getElementById(id);
const ui={ levelName:UI('levelName'), time:UI('time'), stone:UI('stone'), wood:UI('wood'), spears:UI('spears'), lives:UI('lives') };
const btnStart=document.getElementById('btnStart'), btnPause=document.getElementById('btnPause');

function rr(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function hit(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

/* ======= Données ======= */
const NARR=[{t:"Avant le niveau 1 — Les glaces", l:["Tu es Ötzi.","Collecte pierre et bois. Lance le javelot avec ESPACE.","Tu ne peux pas perdre au niveau 1. Appuie sur Entrée pour commencer."]}];
const LVL=[{ name:"1/1 — Montagnes glaciaires (démarrage)", time:75, cold:false, herd:0, stones:6, woods:6 }];

class Player{
  constructor(){ this.x=120; this.y=440; this.r=16; this.vx=0; this.vy=0; this.s=2.2; this.spears=3; this.reload=0; }
  rect(){ return {x:this.x-16,y:this.y-16,w:32,h:32}; }
  update(dt){ this.x=clamp(this.x+this.vx*this.s*dt,16,canvas.width-16); this.y=clamp(this.y+this.vy*this.s*dt,220,canvas.height-16); this.reload=Math.max(0,this.reload-dt); }
  draw(){ ctx.save(); ctx.translate(this.x,this.y);
    ctx.globalAlpha=.25; ctx.beginPath(); ctx.ellipse(0,this.r,this.r*.9,this.r*.4,0,0,6.283); ctx.fillStyle='#1b2a3b'; ctx.fill(); ctx.globalAlpha=1;
    ctx.beginPath(); ctx.moveTo(0,-this.r); ctx.lineTo(this.r*.9,this.r); ctx.lineTo(-this.r*.9,this.r); ctx.closePath(); ctx.fillStyle='#7a5230'; ctx.fill();
    ctx.beginPath(); ctx.arc(0,-this.r*1.2,this.r*.55,0,6.283); ctx.fillStyle='#d7b49e'; ctx.fill(); ctx.restore(); }
}
class Spear{ constructor(x,y){ this.x=x; this.y=y; this.life=0; } update(dt){ this.x+=4*dt*60; this.life+=dt; } draw(){ ctx.strokeStyle='#d7c27a'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(this.x-12,this.y); ctx.lineTo(this.x+12,this.y); ctx.stroke(); } }
class Pickup{ constructor(x,y,type){ this.x=x; this.y=y; this.type=type; this.remove=false; } rect(){ return {x:this.x-12,y:this.y-12,w:24,h:24}; }
  draw(){ ctx.fillStyle=this.type==='stone'?'#9aa4a9':'#8b5a3c'; if(this.type==='stone'){ ctx.beginPath(); ctx.arc(this.x,this.y,10,0,6.283); ctx.fill(); } else { rr(this.x-11,this.y-5,22,10,3); ctx.fill(); } } }

/* ======= État ======= */
let running=false,last=performance.now(),keys=new Set();
let lvl=0, level=null, time=0, lives=3;
let player=null, spears=[], pickups=[], res=null;
let narrative={active:true, idx:0}, grace=5.0;

/* ======= UI ======= */
function drawBG(t){
  ctx.fillStyle='#a4d2ff'; ctx.fillRect(0,0,canvas.width,220);
  ctx.fillStyle='#86c06a'; ctx.fillRect(0,240,canvas.width,canvas.height-240);
}
function overlay(title,lines){
  ctx.fillStyle='rgba(0,0,0,.65)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#1b2433'; rr(canvas.width/2-360,canvas.height/2-130,720,200,14); ctx.fill();
  ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.font='bold 28px system-ui'; ctx.fillText(title,canvas.width/2,canvas.height/2-70);
  ctx.font='16px system-ui'; (lines||[]).forEach((ln,i)=>ctx.fillText(ln,canvas.width/2,canvas.height/2-25+i*22));
  ctx.fillStyle='#1f6feb'; rr(canvas.width/2-140,canvas.height/2+30,280,40,10); ctx.fill();
  ctx.fillStyle='#fff'; ctx.font='bold 16px system-ui'; ctx.fillText('Commencer (Entrée)', canvas.width/2,canvas.height/2+56);
}
function HUD(){ ui.time.textContent=Math.max(0,Math.ceil(time)); ui.stone.textContent=res.stone; ui.wood.textContent=res.wood; ui.spears.textContent=player.spears; ui.lives.textContent=lives; }

/* ======= Niveau ======= */
function initLevel(i){
  lvl=i; level=LVL[i]; time=level.time; lives=3; player=new Player(); spears=[]; pickups=[]; res={stone:0,wood:0};
  grace=5.0;
  const add=(n,t)=>{ for(let k=0;k<n;k++) pickups.push(new Pickup(60+Math.random()*(canvas.width-120), 280+Math.random()*(canvas.height-340), t)); };
  add(level.stones,'stone'); add(level.woods,'wood');
  ui.levelName.textContent=level.name; HUD(); drawBG();
}

/* ======= Boucle ======= */
function loop(){
  if(!running) return;
  const t=performance.now(); let dt=(t-last)/16.67; last=t; dt=Math.min(dt,0.5);

  const up=keys.has('ArrowUp')||keys.has('KeyW'), dn=keys.has('ArrowDown')||keys.has('KeyS'),
        lf=keys.has('ArrowLeft')||keys.has('KeyA'), rg=keys.has('ArrowRight')||keys.has('KeyD');
  player.vx=(rg?1:0)-(lf?1:0); player.vy=(dn?1:0)-(up?1:0); player.update(dt);

  spears.forEach(s=>s.update(dt)); spears=spears.filter(s=>s.life<3 && s.x<canvas.width+20);

  for(const p of pickups){ if(!p.remove && hit(p.rect(), player.rect())){ p.remove=true; res[p.type]++; } }
  pickups=pickups.filter(p=>!p.remove);

  if(grace>0) grace-=dt/60;
  time -= dt/60; if(time<=0) running=false;

  drawBG(t);
  pickups.forEach(p=>p.draw()); player.draw(); spears.forEach(s=>s.draw()); HUD();
  if(!running){ ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(0,0,canvas.width,canvas.height); }
  requestAnimationFrame(loop);
}

/* ======= Actions ======= */
function startGame(){ running=true; last=performance.now(); requestAnimationFrame(loop); }
function shoot(){ if(!running) return; if(player.spears>0 && player.reload===0){ spears.push(new Spear(player.x+20,player.y-10)); player.spears--; player.reload=1.2; HUD(); } }

/* ======= Contrôles ======= */
document.addEventListener('keydown', (e)=>{
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code)) e.preventDefault();

  // Narration : seul Enter agit
  if(narrative.active){
    if(e.code==='Enter'){ initLevel(0); startGame(); narrative.active=false; }
    return; // aucune autre touche en narration
  }

  // En jeu
  if(['ArrowUp','KeyW','ArrowDown','KeyS','ArrowLeft','KeyA','ArrowRight','KeyD'].includes(e.code)) keys.add(e.code);
  if(e.code==='Space') shoot();
  if(e.code==='KeyP'){ running=!running; if(running){ last=performance.now(); requestAnimationFrame(loop); } }
});
document.addEventListener('keyup',(e)=>keys.delete(e.code));

/* ======= Boutons ======= */
btnStart.addEventListener('click', ()=>{ narrative.active=true; narrative.idx=0; drawBG(); overlay(NARR[0].t,NARR[0].l); });
btnPause.addEventListener('click', ()=>{ running=!running; if(running){ last=performance.now(); requestAnimationFrame(loop); } });

/* ======= Boot ======= */
function boot(){ narrative.active=true; drawBG(); overlay(NARR[0].t,NARR[0].l); ui.levelName.textContent='—'; ui.time.textContent='—'; }
window.addEventListener('load', boot);
</script>
</html>
