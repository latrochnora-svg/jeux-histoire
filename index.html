<!doctype html>
<html lang="fr">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ötzi — Des glaces aux villages (PACK PROPRE)</title>
<style>
  html,body{margin:0;height:100%;background:#0e141b;color:#e8eef6;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px}
  canvas{background:#93c5fd;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);
         width:min(980px,95vw);height:calc(min(980px,95vw)*0.56);image-rendering:pixelated;outline:none}
  .hud{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;font-weight:600}
  .kbd{padding:2px 6px;border-radius:6px;background:#223049;font-family:ui-monospace,Menlo,Consolas,monospace}
  button{padding:10px 14px;border-radius:10px;border:0;background:#1f6feb;color:#fff;font-weight:700;cursor:pointer}
  button.secondary{background:#2b3950}
  .pill{padding:3px 8px;border-radius:999px;background:#0b5;color:#fff;font-weight:700;font-size:12px}
  .badge{padding:3px 8px;border-radius:8px;background:#0b5;color:#fff;margin-left:6px}
</style>

<div class="wrap">
  <h1>Ötzi — Des glaces aux villages <span class="badge">PACK PROPRE</span></h1>
  <div class="hud">
    <span>Niveau: <b id="levelName">—</b></span>
    <span>Temps: <b id="time">—</b>s</span>
    <span>Nourriture: <b id="meat">0</b></span>
    <span>Pierre: <b id="stone">0</b></span>
    <span>Bois: <b id="wood">0</b></span>
    <span>Fibres: <b id="fiber">0</b></span>
    <span>Argile: <b id="clay">0</b></span>
    <span>Bétail: <b id="livestock">0</b></span>
    <span>Objets: <b id="crafted">0</b></span>
    <span>Javelots: <b id="spears">3</b></span>
    <span>Vies: <b id="lives">3</b></span>
    <button id="craftBtn" class="secondary" title="2 peaux + 2 fibres">C: Vêtements</button>
    <button id="start">Lancer / Rejouer</button>
    <button id="pause" class="secondary">P: Pause</button>
  </div>
  <div>Commandes : <span class="kbd">← → ↑ ↓</span> / <span class="kbd">W A S D</span> • <span class="kbd">Espace</span> javelot • <span class="kbd">C</span> vêtements • <span class="kbd">F</span> fabriquer • <span class="kbd">Entrée</span> narration • <span class="kbd">1/2/3</span> QCM.</div>
  <canvas id="game" width="960" height="540" tabindex="0" aria-label="Jeu pédagogique Néolithique"></canvas>
  <div style="max-width:min(980px,95vw);text-align:center">
    Étapes : <span class="pill">1. Chasse</span> → <span class="pill">2. Élevage</span> → <span class="pill">3. Artisanat</span> → <span class="pill">4. Agriculture</span>
  </div>
</div>

<script>
['keydown','keypress'].forEach(t=>document.addEventListener(t,e=>{
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space','Enter'].includes(e.code)) e.preventDefault();
},{passive:false}));

const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
const UI=id=>document.getElementById(id);
const ui={ levelName:UI('levelName'), time:UI('time'), meat:UI('meat'), stone:UI('stone'), wood:UI('wood'), fiber:UI('fiber'), clay:UI('clay'),
           livestock:UI('livestock'), crafted:UI('crafted'), spears:UI('spears'), lives:UI('lives') };
const btnStart=document.getElementById('start'), btnPause=document.getElementById('pause'), btnClothes=document.getElementById('craftBtn');

let running=false,last=performance.now(),keys=new Set();
function resize(){ const r=canvas.getBoundingClientRect(),dpr=devicePixelRatio||1; canvas.width=Math.round(r.width*dpr); canvas.height=Math.round(r.height*dpr); if(level) drawBG(levelIndex, performance.now()); }
new ResizeObserver(resize).observe(canvas); resize();

const LEVELS=[
  { name:"1/4 — Montagnes glaciaires (chasse)", duration:70, cold:true,  goals:{meat:3,stone:2,wood:2,fiber:0,clay:0,craft:false,livestock:0,crafted:0}, herd:6,stones:4,woods:3,fibers:0,clays:0,sheep:0 },
  { name:"2/4 — Plateau pastoral (élevage)",    duration:80, cold:false, goals:{meat:1,stone:1,wood:2,fiber:1,clay:0,craft:false,livestock:3,crafted:0}, herd:2,stones:2,woods:3,fibers:2,clays:0,sheep:5, pen:{x:780,y:260,w:150,h:120} },
  { name:"3/4 — Village artisanal (atelier)",    duration:90, cold:false, goals:{meat:0,stone:3,wood:4,fiber:3,clay:3,craft:false,livestock:0,crafted:5}, herd:0,stones:6,woods:6,fibers:6,clays:6,sheep:0, workshop:{x:120,y:270,w:120,h:100} },
  { name:"4/4 — Agriculture & sédentarisation", duration:90, cold:false, goals:{meat:1,stone:3,wood:3,fiber:5,clay:0,craft:true,livestock:0,crafted:0}, herd:2,stones:5,woods:4,fibers:7,clays:0,sheep:0 }
];
const NARRATION=[
  {t:"Avant le niveau 1 — Les glaces", l:["Tu es Ötzi.","Le froid est mordant : chasse et protège-toi.","Objectifs : nourriture, outils, vêtements (2 peaux + 2 fibres)."]},
  {t:"Avant le niveau 2 — Élevage", l:["Les glaces reculent : on apprivoise des animaux.","Approche-les : elles te suivent.","Guide-les dans l’enclos (3)."]},
  {t:"Avant le niveau 3 — Artisanat", l:["Poterie, tissage, outils.","Fabrique 5 objets à l’atelier (F)."]},
  {t:"Avant le niveau 4 — Agriculture", l:["On cultive et on s’installe durablement : sédentarisation.","Atteins les objectifs puis QCM."]},
  {t:"Épilogue — Révolution néolithique", l:["Chasse → Élevage → Artisanat → Agriculture.","Réponds au QCM pour réviser."]}
];

const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
function rr(x,y,w,h,r,fill){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); fill?ctx.fill():ctx.stroke(); }
function hitRect(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }

class Player{ constructor(){ this.x=canvas.width/2; this.y=canvas.height-70; this.r=16; this.vx=0; this.vy=0; this.speed=2.4; this.spears=3; this.reload=0; this.hides=0; this.warm=false; this.inv=0; } update(dt){ this.x=clamp(this.x+this.vx*this.speed*dt, this.r, canvas.width-this.r); this.y=clamp(this.y+this.vy*this.speed*dt, 220, canvas.height-this.r); this.reload=Math.max(0,this.reload-dt); if(this.inv>0) this.inv-=dt; } draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.globalAlpha=.25; ctx.beginPath(); ctx.ellipse(0,this.r,this.r*.9,this.r*.4,0,0,Math.PI*2); ctx.fillStyle='#1b2a3b'; ctx.fill(); ctx.globalAlpha=1; ctx.beginPath(); ctx.moveTo(0,-this.r); ctx.lineTo(this.r*.9,this.r); ctx.lineTo(-this.r*.9,this.r); ctx.closePath(); ctx.fillStyle=this.warm?'#8d6e63':'#7a5230'; ctx.fill(); ctx.beginPath(); ctx.arc(0,-this.r*1.2,this.r*.55,0,Math.PI*2); ctx.fillStyle='#d7b49e'; ctx.fill(); ctx.restore(); } }
class Spear{ constructor(x,y,dir){ this.x=x; this.y=y; this.dir=dir; this.life=0; } update(dt){ this.x+=this.dir*5*dt*60; this.life+=dt; } draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.dir>0?0:Math.PI); ctx.strokeStyle='#d7c27a'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(-12,0); ctx.lineTo(12,0); ctx.stroke(); ctx.restore(); } }
class Bison{ constructor(x,y,dir){ this.x=x; this.y=y; this.dir=dir; this.w=46; this.h=28; this.tagged=false; } update(dt){ if(!this.tagged){ this.x+=this.dir*1.2*dt*60; if(this.x<-60)this.x=canvas.width+60; if(this.x>canvas.width+60)this.x=-60; } } draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle=this.tagged?'#7cb342':'#5a3d2e'; rr(-this.w/2,-this.h/2,this.w,this.h,6,true); ctx.restore(); } rect(){ return {x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h:this.h}; } }
class Sheep{ constructor(x,y){ this.x=x; this.y=y; this.w=28; this.h=18; this.tamed=false; this.vx=(Math.random()<0.5?-1:1)*0.4; this.remove=false; } update(dt,p){ if(!this.tamed){ this.x+=this.vx*dt*60*(0.5+Math.random()*0.2); if(this.x<20||this.x>canvas.width-20)this.vx*=-1; if(hitRect({x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h:this.h},{x:p.x-16,y:p.y-16,w:32,h:32})) this.tamed=true; } else { const dx=p.x-this.x, dy=p.y-this.y; this.x+=Math.sign(dx)*0.9*dt*60; this.y+=Math.sign(dy)*0.6*dt*60; } } draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle=this.tamed?'#fff8cc':'#f1f1f1'; rr(-this.w/2,-this.h/2,this.w,this.h,6,true); ctx.restore(); } rect(){ return {x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h	this.h}; } }
class Pickup{ constructor(x,y,type){ this.x=x; this.y=y; this.type=type; this.remove=false; } draw(){ ctx.save(); ctx.translate(this.x,this.y); const m={stone:'#9aa4a9',wood:'#8b5a3c',fiber:'#b1c94a',clay:'#b46a3a'}; ctx.fillStyle=m[this.type]||'#ccc'; if(this.type==='stone'||this.type==='fiber'||this.type==='clay'){ ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill(); } else { rr(-11,-5,22,10,3,true); } ctx.restore(); } rect(){ return {x:this.x-12,y:this.y-12,w:24,h:24}; } }

let levelIndex=0, level=null, player=null, spears=[], herd=[], sheep=[], pickups=[], time=0, lives=3, res=null, pen=null, workshop=null, narrative={active:true, idx:0}, quiz=null, cold=0;

function drawBG(i,t){
  const sky=['#a4d2ff','#bfe3a1','#bfe3ff','#f5e6b2'][i]; ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,220);
  ctx.fillStyle=['#7aa3c8','#8fc07a','#7cc38e','#d6c877'][i]; ctx.beginPath(); ctx.moveTo(0,220);
  for(let x=0;x<=canvas.width;x+=60){ const k=i===0?40: i===1?18: i===2?14:10; const h=220-(i===0?50:30)-k*Math.sin((x+t*0.0008)*0.01); ctx.lineTo(x,h); }
  ctx.lineTo(canvas.width,220); ctx.closePath(); ctx.fill();
  ctx.fillStyle=['#86c06a','#9ec27a','#7cc38e','#cbbf8c'][i]; ctx.fillRect(0,240,canvas.width,canvas.height-240);
  if(i===1 && pen){ ctx.fillStyle='rgba(139,90,60,0.35)'; ctx.fillRect(pen.x,pen.y,pen.w,pen.h); ctx.strokeStyle='#8b5a3c'; ctx.strokeRect(pen.x,pen.y,pen.w,pen.h); }
  if(i===2 && workshop){ ctx.fillStyle='#c89b6d'; rr(workshop.x,workshop.y,workshop.w,workshop.h,10,true); }
}

function drawNarrative(){
  drawBG(levelIndex, performance.now());
  ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  rr(canvas.width/2-360, canvas.height/2-130, 720, 200, 14, true);
  ctx.fillStyle='#fff'; ctx.textAlign='center';
  ctx.font='bold 28px system-ui'; ctx.fillText(NARRATION[narrative.idx].t, canvas.width/2, canvas.height/2-70);
  ctx.font='16px system-ui'; NARRATION[narrative.idx].l.forEach((ln,i)=>ctx.fillText(ln, canvas.width/2, canvas.height/2-25+i*22));
  ctx.fillStyle='#1f6feb'; rr(canvas.width/2-140, canvas.height/2+30, 280, 40, 10, true);
  ctx.fillStyle='#fff'; ctx.font='bold 16px system-ui'; ctx.fillText('Commencer (Entrée ou clic)', canvas.width/2, canvas.height/2+56);
}

function initLevel(i){
  levelIndex=i; level=LEVELS[i]; player=new Player(); spears=[]; herd=[]; sheep=[]; pickups=[]; res={meat:0,stone:0,wood:0,fiber:0,clay:0,livestock:0,crafted:0}; time=level.duration; lives=3; pen=level.pen||null; workshop=level.workshop||null; cold=0;
  for(let k=0;k<level.herd;k++) herd.push(new Bison(Math.random()*canvas.width, 300+Math.random()*180, Math.random()<0.5?-1:1));
  for(let k=0;k<level.sheep;k++) sheep.push(new Sheep(Math.random()*canvas.width, 300+Math.random()*160));
  const add=(n,type)=>{ for(let k=0;k<n;k++) pickups.push(new Pickup(40+Math.random()*(canvas.width-80), 280+Math.random()*(canvas.height-320), type)); };
  add(level.stones,'stone'); add(level.woods,'wood'); add(level.fibers,'fiber'); add(level.clays,'clay');
  ui.levelName.textContent=level.name; updateHUD(); drawBG(levelIndex, performance.now());
}

function updateHUD(){ ui.time.textContent=Math.max(0,Math.ceil(time)); ui.meat.textContent=res.meat; ui.stone.textContent=res.stone; ui.wood.textContent=res.wood; ui.fiber.textContent=res.fiber; ui.clay.textContent=res.clay; ui.livestock.textContent=res.livestock; ui.crafted.textContent=res.crafted; ui.spears.textContent=player.spears; ui.lives.textContent=lives; }

function loop(){
  if(!running) return;
  const t=performance.now(), dt=(t-last)/16.67; last=t;

  const up=keys.has('ArrowUp')||keys.has('KeyW'); const dn=keys.has('ArrowDown')||keys.has('KeyS'); const lf=keys.has('ArrowLeft')||keys.has('KeyA'); const rg=keys.has('ArrowRight')||keys.has('KeyD');
  player.vx=(rg?1:0)-(lf?1:0); player.vy=(dn?1:0)-(up?1:0); player.update(dt);

  spears.forEach(s=>s.update(dt)); spears=spears.filter(s=>s.life<3 && s.x>-20 && s.x<canvas.width+20);
  herd.forEach(b=>b.update(dt));

  for(const s of spears){ for(const b of herd){ if(!b.tagged && hitRect({x:s.x-6,y:s.y-2,w:12,h:4}, b.rect())){ b.tagged=true; s.life=10; res.meat++; player.hides++; } } }
  for(const b of herd){ if(!b.tagged && player.inv<=0 && hitRect(b.rect(), {x:player.x-16,y:player.y-16,w:32,h:32})){ lives--; player.inv=2; if(lives<=0){ return end(false); } } }

  for(const p of pickups){ if(!p.remove && hitRect(p.rect(), {x:player.x-16,y:player.y-16,w:32,h:32})){ p.remove=true; res[p.type]++; } }
  pickups = pickups.filter(p=>!p.remove);

  if(level.sheep>0 && pen){ for(const sh of sheep){ sh.update(dt,player); if(!sh.remove && sh.tamed && hitRect(sh.rect(), pen)){ sh.remove=true; res.livestock++; } } }
  sheep = sheep.filter(s=>!s.remove);

  if(level.cold && !player.warm){ cold+=dt; if(cold>3){ cold=0; lives--; if(lives<=0){ return end(false); } } }

  time -= dt/60; if(time<=0){ return end(true); }

  drawBG(levelIndex, t);
  pickups.forEach(p=>p.draw());
  herd.forEach(b=>b.draw());
  sheep.forEach(s=>s.draw());
  player.draw();
  spears.forEach(s=>s.draw());
  updateHUD();
  requestAnimationFrame(loop);
}

function shoot(){ if(!running) return; if(player.spears>0 && player.reload===0){ spears.push(new Spear(player.x+20, player.y-10, 1)); player.spears--; player.reload=1.7; updateHUD(); } }
function clothes(){ if(player.warm) return; if(player.hides>=2 && res.fiber>=2){ player.hides-=2; res.fiber-=2; player.warm=true; lives=Math.min(5,lives+1); updateHUD(); } }
function craft(){ if(!running) return; if(!workshop){ return; } const near = hitRect({x:player.x-16,y:player.y-16,w:32,h:32}, workshop); if(!near){ return; }
  if(res.clay>=1 && res.wood>=1){ res.clay--; res.wood--; res.crafted++; }
  else if(res.stone>=1 && res.wood>=1){ res.stone--; res.wood--; res.crafted++; }
  else if(res.fiber>=2){ res.fiber-=2; res.crafted++; }
  updateHUD();
}

function end(timeUp){
  running=false;
  const g=level.goals, r=res; const need=[];
  if(r.meat<g.meat)need.push('nourriture'); if(r.stone<g.stone)need.push('pierre'); if(r.wood<g.wood)need.push('bois'); if(r.fiber<g.fiber)need.push('fibres'); if(r.clay<g.clay)need.push('argile');
  if(g.livestock && r.livestock<g.livestock)need.push('bétail'); if(g.crafted && r.crafted<g.crafted)need.push('objets'); if(g.craft && !player.warm)need.push('vêtements');
  const ok=need.length===0;
  overlay(ok?'Objectif atteint':'Bilan — il manque', ok? 'Entrée/clic pour continuer' : need.join(', '));
  narrative.active=true; narrative.idx = ok ? Math.min(levelIndex+1, 4) : levelIndex;
}

const QUIZ=[
  {q:"Pourquoi l’élevage change la vie des hommes ?",a:["Nourriture plus régulière","Supprime les outils","Supprime le feu"],i:0},
  {q:"La poterie sert surtout à…",a:["Stocker/cuire des aliments","Remplacer la pierre","Faire fuir les prédateurs"],i:0},
  {q:"La sédentarisation signifie…",a:["S’installer durablement","Se déplacer sans arrêt","Vivre isolé"],i:0}
];
let quizState=null;
function showQuiz(){ quizState={i:0,score:0}; drawQuiz(); }
function drawQuiz(){ const it=QUIZ[quizState.i]; overlay("QCM – Révise le Néolithique", "1) "+it.a[0]+"\n2) "+it.a[1]+"\n3) "+it.a[2]+"\nRéponds avec 1/2/3."); }
document.addEventListener('keydown', e=>{
  if(!quizState) return;
  if(e.code==='Digit1'||e.code==='Digit2'||e.code==='Digit3'){
    const it=QUIZ[quizState.i], c=Number(e.code.slice(-1))-1; if(c===it.i) quizState.score++;
    quizState.i++; if(quizState.i>=QUIZ.length){ overlay("Bravo !", "Score : "+quizState.score+"/"+QUIZ.length+"."); quizState=null; } else drawQuiz();
  }
});

document.addEventListener('keydown', e=>{
  if(narrative.active && (e.code==='Enter'||e.code==='Space')){ if(narrative.idx===4){ showQuiz(); } else { initLevel(narrative.idx); startGame(); } return; }
  if(['ArrowUp','KeyW','ArrowDown','KeyS','ArrowLeft','KeyA','ArrowRight','KeyD'].includes(e.code)) keys.add(e.code);
  if(e.code==='Space') shoot();
  if(e.code==='KeyC') clothes();
  if(e.code==='KeyF') craft();
  if(e.code==='KeyP'){ running=!running; if(running){ last=performance.now(); loop(); } }
});
document.addEventListener('keyup', e=> keys.delete(e.code));
document.addEventListener('click', ()=>{ if(narrative.active){ if(narrative.idx===4){ showQuiz(); } else { initLevel(narrative.idx); startGame(); } } });
btnStart.addEventListener('click', ()=>{ narrative.idx=0; narrative.active=true; drawNarrative(); });
btnPause.addEventListener('click', ()=>{ running=!running; if(running){ last=performance.now(); loop(); } });

function overlay(title,text){ ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.font='bold 32px system-ui'; ctx.fillText(title,canvas.width/2,canvas.height/2-20); ctx.font='16px system-ui'; (text||'').split('\n').forEach((ln,i)=>ctx.fillText(ln,canvas.width/2,canvas.height/2+10+i*20)); }
function startGame(){ running=true; last=performance.now(); loop(); }
function boot(){ narrative.active=true; narrative.idx=0; drawNarrative(); }
if(document.readyState==='complete'||document.readyState==='interactive') boot();
else window.addEventListener('DOMContentLoaded', boot);
</script>
</html>
