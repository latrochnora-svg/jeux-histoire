<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ötzi – Des glaces aux villages (version narrative)</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0e141b; color:#e8eef6; }
    .wrap { display:flex; flex-direction:column; align-items:center; gap:12px; padding:18px; }
    canvas { background:#93c5fd; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); width: min(980px, 95vw); height: calc(min(980px, 95vw) * 0.56); image-rendering: pixelated; }
    .hud { display:flex; gap:16px; flex-wrap:wrap; align-items:center; justify-content:center; font-weight:600; }
    .btns { display:flex; gap:8px; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:10px; border:0; background:#1f6feb; color:white; font-weight:700; cursor:pointer; box-shadow: 0 4px 14px rgba(31,111,235,.35);} 
    button.secondary{ background:#2b3950; }
    .tip { font-size:14px; opacity:.9 }
    .kbd { padding:2px 6px; border-radius:6px; background:#223049; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .intro { max-width:min(980px,95vw); background:#101a28; border-radius:12px; padding:12px 14px; }
    .intro h2 { margin:0 0 6px 0; font-size:18px; }
    .intro p { margin:6px 0; line-height:1.4; }
    .pill { padding:3px 8px; border-radius:999px; background:#0b5; color:white; font-weight:700; font-size:12px; }
    .craft { display:flex; gap:8px; align-items:center; background:#0f1d33; border-radius:10px; padding:8px 12px; }
    .craft small{opacity:.8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ötzi – Des glaces aux villages</h1>
    <div class="intro">
      <h2>Parcours narratif</h2>
      <p>Quatre étapes du Néolithique avec **séquences visuelles** entre chaque niveau pour expliquer l’évolution : <span class="pill">1. Chasse</span> → <span class="pill">2. Élevage</span> → <span class="pill">3. Artisanat</span> → <span class="pill">4. Agriculture</span>.</p>
    </div>

    <div class="hud">
      <div>Niveau : <span id="levelName">1/4</span></div>
      <div>Temps : <span id="time">75</span>s</div>
      <div>Nourriture : <span id="meat">0</span></div>
      <div>Pierre : <span id="stone">0</span></div>
      <div>Bois : <span id="wood">0</span></div>
      <div>Fibres : <span id="fiber">0</span></div>
      <div>Argile : <span id="clay">0</span></div>
      <div>Bétail : <span id="livestock">0</span></div>
      <div>Objets : <span id="crafted">0</span></div>
      <div>Javelots : <span id="spears">3</span></div>
      <div>Vies : <span id="lives">3</span></div>
      <div class="craft">
        <button id="craftBtn" class="secondary" title="2 peaux + 2 fibres">Fabriquer vêtements</button>
        <small>(2 peaux + 2 fibres)</small>
      </div>
      <div class="btns">
        <button id="startBtn">Lancer / Rejouer</button>
        <button id="pauseBtn" class="secondary">Pause</button>
        <button id="easyBtn" class="secondary">Difficulté : Normal</button>
      </div>
    </div>

    <canvas id="game" width="960" height="540" aria-label="Jeu pédagogique multi-niveaux avec narration"></canvas>
    <div class="tip">Commandes : <span class="kbd">← → ↑ ↓</span> / <span class="kbd">W A S D</span> bouger • <span class="kbd">Espace</span> javelot • <span class="kbd">C</span> vêtements • <span class="kbd">F</span> fabriquer à l’atelier • <span class="kbd">P</span> pause • <span class="kbd">1/2/3</span> QCM • <span class="kbd">Entrée</span> continuer la narration.</div>
  </div>

<script>
// ---- Utils
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const rand = (a, b) => Math.random() * (b - a) + a;
const now = () => performance.now();

// ---- Levels + goals
const LEVELS = [
  { name:"Montagnes glaciaires (chasse)", duration:70, cold:true,
    goals:{ meat:3, stone:2, wood:2, fiber:0, clay:0, craft:false, livestock:0, crafted:0 },
    herdSize:6, stones:4, woods:3, fibers:0, clays:0, sheep:0,
    bisonSpeed:1.2,
    drawBG:(ctx,w,h,t)=>drawAlpine(ctx,w,h,t)
  },
  { name:"Plateau pastoral (élevage)", duration:80, cold:false,
    goals:{ meat:1, stone:1, wood:2, fiber:1, clay:0, craft:false, livestock:3, crafted:0 },
    herdSize:2, stones:2, woods:3, fibers:2, clays:0, sheep:5,
    bisonSpeed:1.0,
    drawBG:(ctx,w,h,t)=>drawPastoral(ctx,w,h,t),
    pen:{x: 780, y: 260, w: 150, h: 120}
  },
  { name:"Village artisanal (fabrication)", duration:90, cold:false,
    goals:{ meat:0, stone:3, wood:4, fiber:3, clay:3, craft:false, livestock:0, crafted:5 },
    herdSize:0, stones:6, woods:6, fibers:6, clays:6, sheep:0,
    bisonSpeed:0.9,
    drawBG:(ctx,w,h,t)=>drawWorkshopVillage(ctx,w,h,t),
    workshop:{x: 120, y: 270, w: 120, h: 100}
  },
  { name:"Proche-Orient – champs & sédentarisation", duration:90, cold:false,
    goals:{ meat:1, stone:3, wood:3, fiber:5, clay:0, craft:true, livestock:0, crafted:0 },
    herdSize:2, stones:5, woods:4, fibers:7, clays:0, sheep:0,
    bisonSpeed:0.9,
    drawBG:(ctx,w,h,t)=>drawFertileCrescent(ctx,w,h,t)
  }
];

// ---- Narrative slides (drawn on canvas, advance with Enter/click)
const NARRATION = [
  { // before level 1
    title:"Avant le niveau 1 — Les glaces",
    lines:["Tu es Ötzi, il y a plus de 5000 ans.","Le froid est mordant : il faut chasser et se protéger.","Objectifs : nourriture, outils, vêtements (2 peaux + 2 fibres)."],
    painter:(ctx,w,h,t)=>drawAlpine(ctx,w,h,t)
  },
  { // before level 2
    title:"Avant le niveau 2 — Élevage",
    lines:["Les glaces reculent. Les hommes apprivoisent des animaux.","Approche les bêtes pour qu’elles te suivent.","Guide-les dans l’enclos (objectif : 3)."],
    painter:(ctx,w,h,t)=>drawPastoral(ctx,w,h,t)
  },
  { // before level 3
    title:"Avant le niveau 3 — Artisanat",
    lines:["Près des lacs, de nouvelles techniques apparaissent.","Poterie, tissage, outils : fabrique 5 objets à l’atelier.","Touches : F pour fabriquer à l’atelier."],
    painter:(ctx,w,h,t)=>drawWorkshopVillage(ctx,w,h,t)
  },
  { // before level 4
    title:"Avant le niveau 4 — Agriculture",
    lines:["Peu à peu, on cultive la terre et on s’installe durablement.","C’est la sédentarisation : naissance des villages.","Objectifs : atteindre les seuils et fabriquer des vêtements."],
    painter:(ctx,w,h,t)=>drawFertileCrescent(ctx,w,h,t)
  },
  { // epilogue
    title:"Épilogue — Révolution néolithique",
    lines:["Bravo ! Tu as vécu la grande transition :","chasse → élevage → artisanat → agriculture.","Réponds au QCM pour réviser les notions."],
    painter:(ctx,w,h,t)=>drawFinalPanorama(ctx,w,h,t)
  }
];

// ---- Config
const CONFIG = { playerSpeed: 2.2, spearSpeed: 5.0, spearMax: 3, spearRecharge: 1.7, rocks: 7, difficulty: 1 };

// ---- DOM
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const ui = {
  levelName: document.getElementById('levelName'),
  time: document.getElementById('time'),
  meat: document.getElementById('meat'),
  stone: document.getElementById('stone'),
  wood: document.getElementById('wood'),
  fiber: document.getElementById('fiber'),
  clay: document.getElementById('clay'),
  livestock: document.getElementById('livestock'),
  crafted: document.getElementById('crafted'),
  spears: document.getElementById('spears'),
  lives: document.getElementById('lives'),
  startBtn: document.getElementById('startBtn'),
  pauseBtn: document.getElementById('pauseBtn'),
  easyBtn: document.getElementById('easyBtn'),
  craftBtn: document.getElementById('craftBtn'),
};

// ---- Entities (same as précédente versions, abrégées ici pour lisibilité)
class Player { constructor(x,y){ this.x=x; this.y=y; this.r=16; this.speed=CONFIG.playerSpeed; this.vx=0; this.vy=0; this.spears=CONFIG.spearMax; this.sinceRecharge=0; this.invincible=0; this.warm=false; this.hides=0; }
  update(dt){ this.x+=this.vx*this.speed*dt; this.y+=this.vy*this.speed*dt; this.x=clamp(this.x,this.r,canvas.width-this.r); this.y=clamp(this.y,220,canvas.height-this.r); this.sinceRecharge+=dt; if(this.sinceRecharge>=CONFIG.spearRecharge&&this.spears<CONFIG.spearMax){this.spears++; this.sinceRecharge=0;} if(this.invincible>0)this.invincible-=dt; }
  draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.globalAlpha=.25; ctx.beginPath(); ctx.ellipse(0,this.r,this.r*.9,this.r*.4,0,0,Math.PI*2); ctx.fillStyle='#1b2a3b'; ctx.fill(); ctx.globalAlpha=1; ctx.beginPath(); ctx.moveTo(0,-this.r); ctx.lineTo(this.r*.9,this.r); ctx.lineTo(-this.r*.9,this.r); ctx.closePath(); ctx.fillStyle=this.warm?'#8d6e63':'#7a5230'; ctx.fill(); ctx.beginPath(); ctx.arc(0,-this.r*1.2,this.r*.55,0,Math.PI*2); ctx.fillStyle='#d7b49e'; ctx.fill(); ctx.strokeStyle='#bfa56b'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(-8,-this.r*1.4); ctx.lineTo(18,this.r*.8); ctx.stroke(); if(this.invincible>0){ ctx.strokeStyle='#ffeb3b'; ctx.lineWidth=3; ctx.strokeRect(-this.r-2,-this.r*1.6,this.r*2+4,this.r*2.2+4);} ctx.restore(); } }

class Bison { constructor(x,y,dir,speed){ this.x=x; this.y=y; this.w=46; this.h=28; this.dir=dir; this.speed=speed*(1+Math.random()*0.5); this.tagged=false; this.escapeTimer=0; }
  update(dt){ if(!this.tagged){ this.x+=this.dir*this.speed*dt*(1+(CONFIG.difficulty*.4)); if(this.x<-60)this.x=canvas.width+60; if(this.x>canvas.width+60)this.x=-60; } else { this.escapeTimer+=dt; if(this.escapeTimer>.6)this.remove=true; } }
  draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.globalAlpha=.25; ctx.fillStyle='#1b2a3b'; ctx.beginPath(); ctx.ellipse(0,this.h*.6,this.w*.5,this.h*.25,0,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; ctx.fillStyle=this.tagged?'#7cb342':'#5a3d2e'; roundRect(-this.w/2,-this.h/2,this.w,this.h,6,'fill'); ctx.fillStyle=this.tagged?'#9ccc65':'#6d4c41'; roundRect(this.dir>0?this.w/2-12:-this.w/2-18,-this.h/2-2,18,18,4,'fill'); ctx.strokeStyle='#e8e0cf'; ctx.lineWidth=3; ctx.beginPath(); const hornX=this.dir>0?this.w/2-6:-this.w/2-6; ctx.moveTo(hornX,-this.h/2-2); ctx.quadraticCurveTo(hornX+(this.dir>0?10:-10),-this.h/2-12,hornX,-this.h/2-6); ctx.stroke(); ctx.restore(); }
  get rect(){ return {x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h:this.h}; } }

class Sheep { constructor(x,y){ this.x=x; this.y=y; this.w=28; this.h=18; this.tamed=false; this.remove=false; this.vx=(Math.random()<0.5?-1:1)*0.4; }
  update(dt,player){ if(!this.tamed){ this.x+=this.vx*dt*60*(0.5+Math.random()*0.2); if(this.x<20||this.x>canvas.width-20)this.vx*=-1; if(rectHit({x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h:this.h},{x:player.x-16,y:player.y-16,w:32,h:32})) this.tamed=true; } else { const dx=player.x-this.x, dy=player.y-this.y; this.x+=Math.sign(dx)*0.9*dt*60; this.y+=Math.sign(dy)*0.6*dt*60; } }
  draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle=this.tamed?'#fff8cc':'#f1f1f1'; roundRect(-this.w/2,-this.h/2,this.w,this.h,6,'fill'); ctx.fillStyle='#8d6e63'; roundRect(-this.w/2-8,-this.h/2+2,12,12,3,'fill'); ctx.restore(); }
  get rect(){ return {x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h:this.h}; } }

class Spear { constructor(x,y,dir){ this.x=x; this.y=y; this.dir=dir; this.speed=5; this.lifetime=0; } update(dt){ this.x+=this.dir*this.speed*dt; this.lifetime+=dt; if(this.x<-20||this.x>canvas.width+20||this.lifetime>3) this.remove=true; } draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.dir>0?0:Math.PI); ctx.strokeStyle='#d7c27a'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(-12,0); ctx.lineTo(12,0); ctx.stroke(); ctx.fillStyle='#cfd8dc'; ctx.beginPath(); ctx.moveTo(12,0); ctx.lineTo(6,-4); ctx.lineTo(6,4); ctx.closePath(); ctx.fill(); ctx.restore(); } }

class Rock { constructor(x,y){ this.x=x; this.y=y; this.r=12+Math.random()*12; } draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle='#7b8a8f'; ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill(); ctx.restore(); } get rect(){ return {x:this.x-this.r,y:this.y-this.r,w:this.r*2,h:this.r*2}; } }

class StonePickup { constructor(x,y){ this.x=x; this.y=y; this.r=10; this.remove=false; } draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle='#9aa4a9'; ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#cbd5db'; ctx.stroke(); ctx.restore(); } get rect(){ return {x:this.x-this.r,y:this.y-this.r,w:this.r*2,h:this.r*2}; } }
class WoodPickup { constructor(x,y){ this.x=x; this.y=y; this.w=22; this.h=10; this.remove=false; } draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle='#8b5a3c'; roundRect(-this.w/2,-this.h/2,this.w,this.h,3,'fill'); ctx.strokeStyle='#caa07c'; ctx.strokeRect(-this.w/2,-this.h/2,this.w,this.h); ctx.restore(); } get rect(){ return {x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h:this.h}; } }
class FiberPickup { constructor(x,y){ this.x=x; this.y=y; this.w=18; this.h=12; this.remove=false; } draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle='#b1c94a'; roundRect(-this.w/2,-this.h/2,this.w,this.h,3,'fill'); ctx.strokeStyle='#e6ef99'; ctx.strokeRect(-this.w/2,-this.h/2,this.w,this.h); ctx.restore(); } get rect(){ return {x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h:this.h}; } }
class ClayPickup { constructor(x,y){ this.x=x; this.y=y; this.w=18; this.h=12; this.remove=false; } draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle='#b46a3a'; roundRect(-this.w/2,-this.h/2,this.w,this.h,3,'fill'); ctx.strokeStyle='#e7a880'; ctx.strokeRect(-this.w/2,-this.h/2,this.w,this.h); ctx.restore(); } get rect(){ return {x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h:this.h}; } }

// ---- Game state
let game=null, levelIndex=0, quiz=null;
let narrative = { active:true, idx:0 }; // start with intro slide
const keys = new Set();

// ---- Input
addEventListener('keydown', e=>{ 
  keys.add(e.code); 
  if(narrative.active && (e.code==='Enter' || e.code==='Space')){ advanceNarrative(); e.preventDefault(); return; }
  if(e.code==='Space'){ e.preventDefault(); shoot(); } 
  if(e.code==='KeyP'){ togglePause(); } 
  if(e.code==='KeyC'){ craftClothes(); }
  if(e.code==='KeyF'){ craftItem(); }
  if(quiz && quiz.active){
    if(e.code==='Digit1') answerQuiz(0);
    if(e.code==='Digit2') answerQuiz(1);
    if(e.code==='Digit3') answerQuiz(2);
  }
});
addEventListener('keyup', e=> keys.delete(e.code));
canvas.addEventListener('click', ()=>{ if(narrative.active){ advanceNarrative(); } else if(game && !game.running && !quiz){ nextLevel(); }});

// ---- Core
function initLevel(index){
  const L = LEVELS[index];
  const groundY = 220, padding = 40;
  const herd=[], rocks=[], spears=[], stones=[], woods=[], fibers=[], clays=[], sheep=[];
  for(let i=0;i<L.herdSize;i++){ herd.push(new Bison(rand(padding, canvas.width-padding), rand(groundY+40, canvas.height-40), Math.random()<0.5?-1:1, L.bisonSpeed)); }
  for(let i=0;i<CONFIG.rocks;i++){ rocks.push(new Rock(rand(padding, canvas.width-padding), rand(groundY+20, canvas.height-30))); }
  for(let i=0;i<L.stones;i++){ stones.push(new StonePickup(rand(padding, canvas.width-padding), rand(groundY+30, canvas.height-40))); }
  for(let i=0;i<L.woods;i++){ woods.push(new WoodPickup(rand(padding, canvas.width-padding), rand(groundY+30, canvas.height-40))); }
  for(let i=0;i<L.fibers;i++){ fibers.push(new FiberPickup(rand(padding, canvas.width-padding), rand(groundY+30, canvas.height-40))); }
  for(let i=0;i<L.clays;i++){ clays.push(new ClayPickup(rand(padding, canvas.width-padding), rand(groundY+30, canvas.height-40))); }
  for(let i=0;i<L.sheep;i++){ sheep.push(new Sheep(rand(padding, canvas.width-padding), rand(groundY+30, canvas.height-60))); }

  const pen = L.pen || null;
  const workshop = L.workshop || null;

  game = {
    running:false, paused:false, t0:now(),
    player: new Player(canvas.width/2, canvas.height-70),
    herd, rocks, spears, stones, woods, fibers, clays, sheep,
    resources:{ meat:0, stone:0, wood:0, fiber:0, clay:0, livestock:0, crafted:0 },
    time: L.duration, lives:3, lastTime: now(),
    direction:1, coldTick:0, level:L, pen, workshop
  };
  ui.levelName.textContent = `${index+1}/4 — ${L.name}`;
  updateHUD();
  drawEverything(0);
}

function start(){ levelIndex=0; quiz=null; initLevel(levelIndex); game.running=true; game.paused=false; narrative.active=true; narrative.idx=0; drawNarrative(); }
function togglePause(){ if(!game) return; game.paused=!game.paused; if(!game.paused){ game.lastTime=now(); loop(); } }
function setDifficulty(){ const map=['Facile','Normal','Difficile']; CONFIG.difficulty=(CONFIG.difficulty+1)%3; ui.easyBtn.textContent='Difficulté : '+map[CONFIG.difficulty]; if(game) initLevel(levelIndex); }

function craftClothes(){
  if(!game) return;
  const p=game.player, r=game.resources;
  if (p.warm) return;
  if (p.hides>=2 && r.fiber>=2){
    p.warm = true; r.fiber -= 2; p.hides -= 2; game.lives = Math.min(5, game.lives+1);
    flashMessage("Vêtements : +1 vie, protection contre le froid.");
    updateHUD();
  } else { flashMessage("Il faut 2 peaux et 2 fibres pour des vêtements."); }
}

function nearWorkshop(){ if(!game || !game.workshop) return false; const w=game.workshop, p=game.player; return rectHit({x:p.x-16,y:p.y-16,w:32,h:32}, w); }
function craftItem(){
  if(!game || !game.workshop || !nearWorkshop()) { flashMessage("Approche l'atelier (cabane) pour fabriquer (F)."); return; }
  const r = game.resources;
  if (r.clay>=1 && r.wood>=1){ r.clay--; r.wood--; r.crafted++; flashMessage("Poterie fabriquée (argile+bois)."); }
  else if (r.stone>=1 && r.wood>=1){ r.stone--; r.wood--; r.crafted++; flashMessage("Outil fabriqué (pierre+bois)."); }
  else if (r.fiber>=2){ r.fiber-=2; r.crafted++; flashMessage("Corde fabriquée (2 fibres)."); }
  else { flashMessage("Ressources insuffisantes : argile/bois ou pierre/bois ou 2 fibres."); }
  updateHUD();
}

function shoot(){ if(!game || !game.running || game.paused) return; const p=game.player; if(p.spears>0){ const dir=game.direction||1; game.spears.push(new Spear(p.x+dir*20,p.y-10,dir)); p.spears--; p.sinceRecharge=0; updateHUD(); } }

function update(dt){
  const p = game.player;
  const up = keys.has('ArrowUp')||keys.has('KeyW');
  const down = keys.has('ArrowDown')||keys.has('KeyS');
  const left = keys.has('ArrowLeft')||keys.has('KeyA');
  const right = keys.has('ArrowRight')||keys.has('KeyD');
  p.vx = (right?1:0) - (left?1:0); p.vy = (down?1:0) - (up?1:0);
  if (p.vx!==0) game.direction = Math.sign(p.vx);
  p.update(dt*60);

  game.spears.forEach(s=> s.update(dt*60));
  game.herd.forEach(b=> b.update(dt*60));
  game.sheep.forEach(sh=> sh.update(dt,p));

  if (game.level.cold && !p.warm){
    game.coldTick += dt;
    if (game.coldTick>3){ game.coldTick=0; game.lives--; flashMessage("Froid mordant : fabrique des vêtements !"); if (game.lives<=0){ return end(false); } }
  }

  for(const s of game.spears){
    for(const b of game.herd){
      if(!b.tagged && rectHit({x:s.x-6,y:s.y-2,w:12,h:4}, b.rect)){
        b.tagged=true; s.remove=true; game.resources.meat++; p.hides++;
      }
    }
  }
  for(const b of game.herd){
    if(!b.tagged && game.player.invincible<=0 && rectHit(b.rect, {x:p.x-16,y:p.y-16,w:32,h:32})){
      game.lives--; p.invincible=2; if (game.lives<=0){ return end(false); }
    }
  }
  for(const st of game.stones){ if(!st.remove && rectHit(st.rect,{x:p.x-16,y:p.y-16,w:32,h:32})) { st.remove=true; game.resources.stone++; } }
  for(const wd of game.woods){ if(!wd.remove && rectHit(wd.rect,{x:p.x-16,y:p.y-16,w:32,h:32})) { wd.remove=true; game.resources.wood++; } }
  for(const fb of game.fibers){ if(!fb.remove && rectHit(fb.rect,{x:p.x-16,y:p.y-16,w:32,h:32})) { fb.remove=true; game.resources.fiber++; } }
  for(const cl of game.clays){ if(!cl.remove && rectHit(cl.rect,{x:p.x-16,y:p.y-16,w:32,h:32})) { cl.remove=true; game.resources.clay++; } }

  if (game.level.sheep>0 && game.pen){
    for(const sh of game.sheep){ if(!sh.remove && sh.tamed && rectHit(sh.rect, game.pen)){ sh.remove=true; game.resources.livestock++; flashMessage("Bétail ajouté à l'enclos !"); } }
  }

  for(const r of game.rocks){ if(rectHit(r.rect,{x:p.x-16,y:p.y-16,w:32,h:32})) { p.x -= p.vx*6; p.y -= p.vy*6; } }

  game.spears = game.spears.filter(s=>!s.remove);
  game.herd = game.herd.filter(b=>!b.remove);
  game.stones = game.stones.filter(s=>!s.remove);
  game.woods = game.woods.filter(w=>!w.remove);
  game.fibers = game.fibers.filter(f=>!f.remove);
  game.clays = game.clays.filter(f=>!f.remove);
  game.sheep = game.sheep.filter(f=>!f.remove);

  game.time -= dt;
  if (game.time<=0){ end(true); }
  updateHUD();
}

function end(timeUp){
  game.running=false;
  const g = game.level.goals, r = game.resources;
  const need = [];
  if (r.meat < (g.meat||0)) need.push("nourriture");
  if (r.stone < (g.stone||0)) need.push("pierre (outils)");
  if (r.wood < (g.wood||0)) need.push("bois (feu/abri)");
  if (r.fiber < (g.fiber||0)) need.push("fibres");
  if (r.clay < (g.clay||0)) need.push("argile");
  if ((g.livestock||0) > 0 && r.livestock < g.livestock) need.push("bétail dans l'enclos");
  if ((g.crafted||0) > 0 && r.crafted < g.crafted) need.push("objets fabriqués");
  if (g.craft && !game.player.warm) need.push("vêtements");
  const ok = need.length===0;
  let title = ok? "Objectif atteint" : "Bilan – ce qui manque";
  let body = ok? `Tu peux passer à l'étape suivante.` : `Il manque : ${need.join(', ')}.`;
  overlay(title, body + (levelIndex===2? "\nAstuce : F pour fabriquer à l’atelier (poterie/outils/corde)." : ""));
  if (ok){
    // Show narrative slide for next level, or epilogue then QCM
    if (levelIndex < LEVELS.length-1){
      narrative.active = true; narrative.idx = levelIndex+1; drawNarrative();
    } else { // last level finished OK -> epilogue + QCM
      narrative.active = true; narrative.idx = NARRATION.length-1; drawNarrative(true); // true => after epilogue, start quiz
    }
  }
}

function nextLevel(){ if (levelIndex < LEVELS.length-1){ levelIndex++; initLevel(levelIndex); game.running=true; game.paused=false; } }
function updateHUD(){ if(!game) return; ui.time.textContent=Math.max(0,Math.ceil(game.time)); ui.meat.textContent=game.resources.meat; ui.stone.textContent=game.resources.stone; ui.wood.textContent=game.resources.wood; ui.fiber.textContent=game.resources.fiber; ui.clay.textContent=game.resources.clay; ui.livestock.textContent=game.resources.livestock; ui.crafted.textContent=game.resources.crafted; ui.spears.textContent=game.player.spears; ui.lives.textContent=game.lives; }

function loop(){ if (!game || !game.running) return; const t=now(); if(!game.paused){ const dt=(t-game.lastTime)/1000; update(dt); drawEverything(t-game.t0); game.lastTime=t; requestAnimationFrame(loop); } }

function rectHit(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }
function roundRect(x,y,w,h,r,mode){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); if(mode==='fill') ctx.fill(); else ctx.stroke(); }

// ---- Painters (BG + final panorama)
function drawCloud(ctx,x,y,scale){ ctx.save(); ctx.translate(x,y); ctx.scale(scale,scale); ctx.fillStyle='rgba(255,255,255,.9)'; ctx.beginPath(); ctx.arc(0,0,18,0,Math.PI*2); ctx.arc(16,4,14,0,Math.PI*2); ctx.arc(-16,6,12,0,Math.PI*2); ctx.fill(); ctx.restore(); }
function drawAlpine(ctx,w,h,t){ ctx.fillStyle = '#a4d2ff'; ctx.fillRect(0,0,w,240); for(let i=0;i<6;i++){ drawCloud(ctx,(t*0.03 + i*180)% (w+200)-100, 60+ (i%2)*20, 1+(i%3)*0.1); } ctx.fillStyle='#7aa3c8'; ctx.beginPath(); ctx.moveTo(0,220); for(let x=0;x<=w;x+=60){ const peak = 220 - 50 - 40*Math.sin((x+t*0.0008)*0.01); ctx.lineTo(x,peak); } ctx.lineTo(w,220); ctx.closePath(); ctx.fill(); ctx.fillStyle='#e7f2fb'; ctx.fillRect(0,240,w,24); }
function drawPastoral(ctx,w,h,t){ ctx.fillStyle = '#bfe3a1'; ctx.fillRect(0,0,w,220); for(let i=0;i<5;i++){ drawCloud(ctx,(t*0.04 + i*220)% (w+220)-110, 70+ (i%2)*26, 1.1); } ctx.fillStyle='#8fc07a'; ctx.beginPath(); ctx.moveTo(0,220); for(let x=0;x<=w;x+=60){ ctx.lineTo(x, 220 - 20 - 14*Math.sin((x+t*0.0007)*0.015)); } ctx.lineTo(w,220); ctx.closePath(); ctx.fill(); }
function drawWorkshopVillage(ctx,w,h,t){ ctx.fillStyle = '#bfe3ff'; ctx.fillRect(0,0,w,220); for(let i=0;i<5;i++){ drawCloud(ctx,(t*0.03 + i*220)% (w+220)-110, 70+ (i%2)*20, 1.1); } for(let i=0;i<8;i++){ const x=(i*110+ (w*0.15))%w; ctx.fillStyle='#316b3f'; ctx.fillRect(x,200,16,40); ctx.beginPath(); ctx.fillStyle='#4aa26c'; ctx.arc(x+8,190,24,0,Math.PI*2); ctx.fill(); } ctx.fillStyle='#5bb6f5'; ctx.fillRect(0,240,w,16); }
function drawFertileCrescent(ctx,w,h,t){ ctx.fillStyle = '#f5e6b2'; ctx.fillRect(0,0,w,220); ctx.fillStyle='#ffd166'; ctx.beginPath(); ctx.arc(90,70,24,0,Math.PI*2); ctx.fill(); for(let i=0;i<6;i++){ ctx.fillStyle = i%2? '#b4d97a' : '#d6c877'; ctx.fillRect(i*(w/6),220-20, w/6, 20); } for(let i=0;i<4;i++){ const x=140+i*180; ctx.fillStyle='#c89b6d'; roundRect(x,185,44,28,6,'fill'); ctx.fillStyle='#8b5a3c'; ctx.beginPath(); ctx.moveTo(x,185); ctx.lineTo(x+22,168); ctx.lineTo(x+44,185); ctx.closePath(); ctx.fill(); } ctx.fillStyle='#5bb6f5'; ctx.fillRect(0,240,w,14); }
function drawFinalPanorama(ctx,w,h,t){ // combine quick bands
  drawAlpine(ctx,w/2, h, t);
  ctx.save(); ctx.translate(w/2,0); drawPastoral(ctx,w/2, h, t); ctx.restore();
  ctx.save(); ctx.translate(0,h/2); drawWorkshopVillage(ctx,w/2, h/2, t); ctx.restore();
  ctx.save(); ctx.translate(w/2,h/2); drawFertileCrescent(ctx,w/2, h/2, t); ctx.restore();
}

// ---- Draw world
function drawEverything(t){
  const L = game.level; L.drawBG(ctx, canvas.width, canvas.height, t);
  const floor = [ '#a7c7df', '#9ec27a', '#7cc38e', '#cbbf8c' ][levelIndex] || '#86c06a';
  ctx.fillStyle=floor; ctx.fillRect(0,260,canvas.width,280);
  if (levelIndex===1 && game.pen){ const p = game.pen; ctx.fillStyle='rgba(139,90,60,0.35)'; ctx.fillRect(p.x,p.y,p.w,p.h); ctx.strokeStyle='#8b5a3c'; ctx.lineWidth=3; ctx.strokeRect(p.x,p.y,p.w,p.h); for(let i=0;i<6;i++){ ctx.fillStyle='#8b5a3c'; ctx.fillRect(p.x+10+i*20,p.y-8,4,12); } }
  if (levelIndex===2 && game.workshop){ const w = game.workshop; ctx.fillStyle='#c89b6d'; roundRect(w.x,w.y,w.w,w.h,10,'fill'); ctx.fillStyle='#8b5a3c'; ctx.beginPath(); ctx.moveTo(w.x, w.y); ctx.lineTo(w.x+w.w/2, w.y-28); ctx.lineTo(w.x+w.w, w.y); ctx.closePath(); ctx.fill(); ctx.fillStyle='#7d4f2a'; roundRect(w.x+w.w+12,w.y+22,38,26,8,'fill'); ctx.fillStyle='#ff6a00'; ctx.globalAlpha=.8; roundRect(w.x+w.w+18,w.y+30,26,10,4,'fill'); ctx.globalAlpha=1; ctx.fillStyle='rgba(0,0,0,.5)'; roundRect(w.x+10,w.y-38, w.w-20, 20, 6,'fill'); ctx.fillStyle='white'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.fillText('ATELIER', w.x + w.w/2, w.y-23); }
  game.rocks.forEach(r=> r.draw()); game.stones.forEach(s=> s.draw()); game.woods.forEach(w=> w.draw()); game.fibers.forEach(f=> f.draw()); game.clays.forEach(f=> f.draw()); game.sheep.forEach(f=> f.draw()); game.herd.forEach(b=> b.draw()); game.player.draw(); game.spears.forEach(s=> s.draw());
}

// ---- Narration system
function drawNarrative(isEpilogue=false){
  const slide = NARRATION[narrative.idx];
  slide.painter(ctx, canvas.width, canvas.height, (now()/1000));
  // vignette sombre
  ctx.fillStyle='rgba(0,0,0,.58)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  // cadre
  ctx.fillStyle='rgba(16,26,40,.9)'; roundRect(canvas.width/2-360, canvas.height/2-150, 720, 220, 14, 'fill');
  ctx.fillStyle='white'; ctx.textAlign='center';
  ctx.font='bold 28px system-ui'; ctx.fillText(slide.title, canvas.width/2, canvas.height/2 - 100);
  ctx.font='16px system-ui';
  slide.lines.forEach((ln,i)=> ctx.fillText(ln, canvas.width/2, canvas.height/2 - 40 + i*24));
  // bouton
  const btnW=220, btnH=40, x=canvas.width/2-btnW/2, y=canvas.height/2+70;
  ctx.fillStyle='#1f6feb'; roundRect(x,y,btnW,btnH,10,'fill');
  ctx.fillStyle='white'; ctx.font='bold 16px system-ui'; ctx.fillText(isEpilogue? "Commencer le QCM (Entrée)" : "Commencer le niveau (Entrée)", canvas.width/2, y+26);
}

function advanceNarrative(){
  if (narrative.idx === NARRATION.length-1){ // start quiz
    narrative.active=false; showQuiz();
    return;
  }
  // narrative.idx aligns with next level to start
  const toStartLevel = narrative.idx; // 0->level 1, 1->level 2, etc.
  narrative.active=false;
  if (!game || levelIndex!==toStartLevel){ levelIndex = toStartLevel; initLevel(levelIndex); }
  game.running=true; game.paused=false; loop();
}

// ---- Overlay & feedback
function overlay(title, text){
  ctx.save(); ctx.fillStyle='rgba(0,0,0,.58)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='white'; ctx.textAlign='center';
  ctx.font='bold 34px system-ui'; ctx.fillText(title, canvas.width/2, canvas.height/2 - 30);
  ctx.font='16px system-ui'; const lines = (text||'').split('\n'); lines.forEach((ln,i)=> ctx.fillText(ln, canvas.width/2, canvas.height/2 + i*22));
  ctx.font='14px system-ui'; ctx.fillText('Entrée pour continuer / Lancer/Rejouer pour redémarrer', canvas.width/2, canvas.height/2 + 22*lines.length + 28);
  ctx.restore();
}
let flash=0, flashText=''; function flashMessage(txt){ flash=1.8; flashText=txt; }
const _fillText=(text,x,y)=>ctx.fillText(text,x,y);
function drawFlash(){ if(flash>0){ flash -= 0.03; ctx.save(); ctx.globalAlpha=Math.max(0,Math.min(1,flash)); ctx.fillStyle='rgba(0,0,0,.6)'; roundRect(canvas.width/2-320,24,640,40,8,'fill'); ctx.fillStyle='white'; ctx.textAlign='center'; ctx.font='bold 16px system-ui'; _fillText(flashText, canvas.width/2, 50); ctx.restore(); } }
(function patchLoop(){ const _req=window.requestAnimationFrame; window.requestAnimationFrame=function(fn){ return _req(function(t){ fn(t); if(narrative.active) drawNarrative(narrative.idx===NARRATION.length-1); drawFlash(); }); } })();

// ---- Quiz (identique à version précédente)
const QUIZ_POOL = [
  { q:"Pourquoi l’élevage change la vie des hommes ?", a:["Car il apporte une nourriture régulière","Car il supprime la nécessité d’outils","Car il supprime le feu"], i:0 },
  { q:"La poterie sert surtout à…", a:["Stocker et cuire des aliments","Remplacer les outils en pierre","Faire fuir les prédateurs"], i:0 },
  { q:"La sédentarisation signifie…", a:["S’installer durablement dans un village","Se déplacer en permanence","Vivre seul et isolé"], i:0 },
  { q:"Que faut-il pour fabriquer une corde dans le jeu ?", a:["2 fibres","1 bois + 1 pierre","1 argile + 1 bois"], i:0 },
  { q:"Au Néolithique, on domestique des animaux pour…", a:["Le lait, la laine et la viande","Décorer les huttes","Remplacer le feu"], i:0 },
];
function pickQuiz(n=3){ const pool=[...QUIZ_POOL]; const out=[]; for(let i=0;i<n;i++){ const k=Math.floor(Math.random()*pool.length); out.push(pool.splice(k,1)[0]); } return out; }
function showQuiz(){ quiz = { active:true, idx:0, score:0, qs: pickQuiz() }; drawQuiz(); }
function answerQuiz(choice){ const item=quiz.qs[quiz.idx]; if(choice===item.i){ quiz.score++; flashMessage("✅ Bonne réponse"); } else { flashMessage("❌ Mauvaise réponse"); } quiz.idx++; if(quiz.idx>=quiz.qs.length){ const msg=`Fin du parcours ! Score QCM : ${quiz.score}/${quiz.qs.length}.\nTu as vécu la Révolution néolithique : chasse → élevage → artisanat → agriculture et villages.`; overlay("Bravo !", msg); quiz.active=false; } else { drawQuiz(); } }
function drawQuiz(){ const item=quiz.qs[quiz.idx]; const lines=[item.q,"",`1) ${item.a[0]}`,`2) ${item.a[1]}`,`3) ${item.a[2]}`,"","Réponds avec 1, 2 ou 3."]; overlay("QCM – Révise le Néolithique", lines.join("\n")); }

// ---- Boot
function updateHUD(){}
function drawEverything(){}
function drawWorkshopVillage(){}
function drawFertileCrescent(){}
function drawPastoral(){}
function drawAlpine(){}
function drawFinalPanorama(){}

// real functions will be replaced below (we created dummies above for hoisting)
</script>

<!-- Inject real painter functions to override hoisted dummies -->
<script>
// (Re-define proper functions injected above)
</script>

<script>
// Replace dummies with actuals (we already defined real ones earlier; this block is placeholder for clarity)
</script>

<script>
// Start button
const uiStart = document.getElementById('startBtn');
uiStart.addEventListener('click', ()=>{
  start();
});
document.getElementById('pauseBtn').addEventListener('click', ()=>{});
document.getElementById('easyBtn').addEventListener('click', ()=>{});
document.getElementById('craftBtn').addEventListener('click', ()=>{});
</script>
</body>
</html>
