<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ötzi – Des glaces aux villages</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0e141b; color:#e8eef6; }
    .wrap { display:flex; flex-direction:column; align-items:center; gap:12px; padding:18px; }
    canvas { background:#93c5fd; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); width: min(980px, 95vw); height: calc(min(980px, 95vw) * 0.56); image-rendering: pixelated; }
    .hud { display:flex; gap:16px; flex-wrap:wrap; align-items:center; justify-content:center; font-weight:600; }
    .btns { display:flex; gap:8px; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:10px; border:0; background:#1f6feb; color:white; font-weight:700; cursor:pointer; box-shadow: 0 4px 14px rgba(31,111,235,.35);} 
    button.secondary{ background:#2b3950; }
    .tip { font-size:14px; opacity:.9 }
    .kbd { padding:2px 6px; border-radius:6px; background:#223049; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .intro { max-width:min(980px,95vw); background:#101a28; border-radius:12px; padding:12px 14px; }
    .intro h2 { margin:0 0 6px 0; font-size:18px; }
    .intro p { margin:6px 0; line-height:1.4; }
    .pill { padding:3px 8px; border-radius:999px; background:#0b5; color:white; font-weight:700; font-size:12px; }
    .craft { display:flex; gap:8px; align-items:center; background:#0f1d33; border-radius:10px; padding:8px 12px; }
    .craft small{opacity:.8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ötzi – Des glaces aux villages</h1>
    <div class="intro">
      <h2>Parcours pédagogique</h2>
      <p>Traverse trois niveaux inspirés de ton cours sur la « révolution » néolithique : <span class="pill">Montagnes glaciaires</span> (chasse & protection contre le froid), <span class="pill">Bord de lac – Chalain</span> (collecte & artisanat), <span class="pill">Proche-Orient</span> (champs & sédentarisation).</p>
      <p>Objectif : rassembler <strong>nourriture</strong>, <strong>pierre</strong> et <strong>bois</strong>, puis <strong>fabriquer des vêtements</strong> (peaux + fibres) pour survivre et fonder le camp. Un bilan relie tes actions aux notions (domestication, artisanat, sédentarisation).</p>
    </div>

    <div class="hud">
      <div>Niveau : <span id="levelName">1/3</span></div>
      <div>Temps : <span id="time">75</span>s</div>
      <div>Nourriture : <span id="meat">0</span></div>
      <div>Pierre : <span id="stone">0</span></div>
      <div>Bois : <span id="wood">0</span></div>
      <div>Fibres : <span id="fiber">0</span></div>
      <div>Javelots : <span id="spears">3</span></div>
      <div>Vies : <span id="lives">3</span></div>
      <div class="craft">
        <button id="craftBtn" class="secondary" title="2 peaux + 2 fibres">Fabriquer vêtements</button>
        <small>(nécessite 2 peaux + 2 fibres)</small>
      </div>
      <div class="btns">
        <button id="startBtn">Lancer / Rejouer</button>
        <button id="pauseBtn" class="secondary">Pause</button>
        <button id="easyBtn" class="secondary">Niveau de difficulté : Normal</button>
      </div>
    </div>

    <canvas id="game" width="960" height="540" aria-label="Jeu de survie préhistorique multi-niveaux"></canvas>
    <div class="tip">Commandes : <span class="kbd">← → ↑ ↓</span> ou <span class="kbd">W A S D</span> pour bouger • <span class="kbd">Espace</span> pour lancer un javelot • <span class="kbd">C</span> pour fabriquer • <span class="kbd">P</span> pour pause.</div>
  </div>

<script>
// ===== Utils
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const rand = (a, b) => Math.random() * (b - a) + a;
const now = () => performance.now();

// ===== Levels (scenery + goals linked to course)
const LEVELS = [
  { name:"Montagnes glaciaires (chasse)", duration:75, cold:true,
    goals:{ meat:3, stone:2, wood:2, fiber:0, craft:false },
    herdSize:6, stones:4, woods:3, fibers:0,
    bisonSpeed:1.2,
    drawBG: (ctx,w,h,t)=>drawAlpine(ctx,w,h,t)
  },
  { name:"Bord de lac – Chalain (collecte & artisanat)", duration:85, cold:false,
    goals:{ meat:2, stone:3, wood:4, fiber:3, craft:true },
    herdSize:4, stones:5, woods:6, fibers:5,
    bisonSpeed:1.0,
    drawBG: (ctx,w,h,t)=>drawLakeside(ctx,w,h,t)
  },
  { name:"Proche-Orient – champs & sédentarisation", duration:90, cold:false,
    goals:{ meat:1, stone:3, wood:3, fiber:5, craft:true },
    herdSize:2, stones:5, woods:4, fibers:7,
    bisonSpeed:0.9,
    drawBG: (ctx,w,h,t)=>drawFertileCrescent(ctx,w,h,t)
  }
];

// ===== Config
const CONFIG = {
  playerSpeed: 2.2,
  spearSpeed: 5.0,
  spearMax: 3,
  spearRecharge: 1.7,
  rocks: 7,
  difficulty: 1, // 0 easy,1 normal,2 hard
};

// ===== DOM
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const ui = {
  levelName: document.getElementById('levelName'),
  time: document.getElementById('time'),
  meat: document.getElementById('meat'),
  stone: document.getElementById('stone'),
  wood: document.getElementById('wood'),
  fiber: document.getElementById('fiber'),
  spears: document.getElementById('spears'),
  lives: document.getElementById('lives'),
  startBtn: document.getElementById('startBtn'),
  pauseBtn: document.getElementById('pauseBtn'),
  easyBtn: document.getElementById('easyBtn'),
  craftBtn: document.getElementById('craftBtn'),
};

// ===== Entities
class Player {
  constructor(x,y){
    this.x=x; this.y=y; this.r=16; this.speed=CONFIG.playerSpeed;
    this.vx=0; this.vy=0; this.spears=CONFIG.spearMax; this.sinceRecharge=0;
    this.invincible=0; this.warm=false; this.hides=0; // peaux pour vêtements
  }
  update(dt){
    this.x += this.vx * this.speed * dt; 
    this.y += this.vy * this.speed * dt; 
    this.x = clamp(this.x, this.r, canvas.width - this.r);
    this.y = clamp(this.y, 220, canvas.height - this.r);
    this.sinceRecharge += dt;
    if (this.sinceRecharge >= CONFIG.spearRecharge && this.spears < CONFIG.spearMax){
      this.spears++; this.sinceRecharge=0;
    }
    if (this.invincible>0) this.invincible -= dt;
  }
  draw(){
    ctx.save(); ctx.translate(this.x, this.y);
    // ombre
    ctx.globalAlpha = 0.25; ctx.beginPath(); ctx.ellipse(0, this.r, this.r*0.9, this.r*0.4, 0, 0, Math.PI*2); ctx.fillStyle = '#1b2a3b'; ctx.fill(); ctx.globalAlpha = 1;
    // manteau
    ctx.beginPath(); ctx.moveTo(0,-this.r); ctx.lineTo(this.r*0.9,this.r); ctx.lineTo(-this.r*0.9,this.r); ctx.closePath();
    ctx.fillStyle = this.warm? '#8d6e63' : '#7a5230'; ctx.fill();
    // tête
    ctx.beginPath(); ctx.arc(0,-this.r*1.2, this.r*0.55, 0, Math.PI*2); ctx.fillStyle = '#d7b49e'; ctx.fill();
    // javelot
    ctx.strokeStyle = '#bfa56b'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(-8, -this.r*1.4); ctx.lineTo(18, this.r*0.8); ctx.stroke();
    if (this.invincible>0){ ctx.strokeStyle='#ffeb3b'; ctx.lineWidth=3; ctx.strokeRect(-this.r-2,-this.r*1.6,this.r*2+4,this.r*2.2+4); }
    ctx.restore();
  }
}

class Bison {
  constructor(x,y,dir,speed){ this.x=x; this.y=y; this.w=46; this.h=28; this.dir=dir; this.speed=speed*(1+Math.random()*0.5); this.tagged=false; this.escapeTimer=0; }
  update(dt){
    if (!this.tagged){
      this.x += this.dir * this.speed * dt * (1 + (CONFIG.difficulty*0.4));
      if (this.x < -60){ this.x = canvas.width + 60; }
      if (this.x > canvas.width + 60){ this.x = -60; }
    } else { this.escapeTimer += dt; if (this.escapeTimer>0.6) this.remove=true; }
  }
  draw(){
    ctx.save(); ctx.translate(this.x, this.y);
    ctx.globalAlpha=0.25; ctx.fillStyle='#1b2a3b'; ctx.beginPath(); ctx.ellipse(0,this.h*0.6,this.w*0.5,this.h*0.25,0,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
    ctx.fillStyle = this.tagged? '#7cb342' : '#5a3d2e';
    roundRect(-this.w/2,-this.h/2,this.w,this.h,6,'fill');
    ctx.fillStyle = this.tagged? '#9ccc65' : '#6d4c41';
    roundRect(this.dir>0? this.w/2-12 : -this.w/2-18, -this.h/2-2, 18, 18, 4, 'fill');
    ctx.strokeStyle='#e8e0cf'; ctx.lineWidth=3; ctx.beginPath();
    const hornX = this.dir>0? this.w/2-6 : -this.w/2-6; ctx.moveTo(hornX,-this.h/2-2); ctx.quadraticCurveTo(hornX+(this.dir>0?10:-10), -this.h/2-12, hornX, -this.h/2-6); ctx.stroke();
    ctx.restore();
  }
  get rect(){ return {x:this.x-this.w/2, y:this.y-this.h/2, w:this.w, h:this.h}; }
}

class Spear { constructor(x,y,dir){ this.x=x; this.y=y; this.dir=dir; this.speed=5; this.lifetime=0; }
  update(dt){ this.x += this.dir * this.speed * dt; this.lifetime += dt; if (this.x<-20||this.x>canvas.width+20||this.lifetime>3){ this.remove=true; } }
  draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.dir>0?0:Math.PI);
    ctx.strokeStyle='#d7c27a'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(-12,0); ctx.lineTo(12,0); ctx.stroke();
    ctx.fillStyle='#cfd8dc'; ctx.beginPath(); ctx.moveTo(12,0); ctx.lineTo(6,-4); ctx.lineTo(6,4); ctx.closePath(); ctx.fill(); ctx.restore(); } }

class Rock { constructor(x,y){ this.x=x; this.y=y; this.r=12+Math.random()*12; }
  draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle='#7b8a8f'; ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill(); ctx.restore(); }
  get rect(){ return {x:this.x-this.r, y:this.y-this.r, w:this.r*2, h:this.r*2}; } }

class StonePickup { constructor(x,y){ this.x=x; this.y=y; this.r=10; this.remove=false; }
  draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle='#9aa4a9'; ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#cbd5db'; ctx.stroke(); ctx.restore(); }
  get rect(){ return {x:this.x-this.r, y:this.y-this.r, w:this.r*2, h:this.r*2}; } }
class WoodPickup { constructor(x,y){ this.x=x; this.y=y; this.w=22; this.h=10; this.remove=false; }
  draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle='#8b5a3c'; roundRect(-this.w/2,-this.h/2,this.w,this.h,3,'fill'); ctx.strokeStyle='#caa07c'; ctx.strokeRect(-this.w/2,-this.h/2,this.w,this.h); ctx.restore(); }
  get rect(){ return {x:this.x-this.w/2, y:this.y-this.h/2, w:this.w, h:this.h}; } }
class FiberPickup { constructor(x,y){ this.x=x; this.y=y; this.w=18; this.h=12; this.remove=false; }
  draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle='#b1c94a'; roundRect(-this.w/2,-this.h/2,this.w,this.h,3,'fill'); ctx.strokeStyle='#e6ef99'; ctx.strokeRect(-this.w/2,-this.h/2,this.w,this.h); ctx.restore(); }
  get rect(){ return {x:this.x-this.w/2, y:this.y-this.h/2, w:this.w, h:this.h}; } }

// ===== Game state
let game=null, levelIndex=0;
const keys = new Set();
addEventListener('keydown', e=>{ keys.add(e.code); if(e.code==='Space'){ e.preventDefault(); shoot(); } if(e.code==='KeyP'){ togglePause(); } if(e.code==='KeyC'){ craft(); }});
addEventListener('keyup', e=> keys.delete(e.code));

// ===== Init & Loop
function initLevel(index){
  const L = LEVELS[index];
  const groundY = 220, padding = 40;
  const herd=[], rocks=[], spears=[], stones=[], woods=[], fibers=[];
  for(let i=0;i<L.herdSize;i++){ herd.push(new Bison(rand(padding, canvas.width-padding), rand(groundY+40, canvas.height-40), Math.random()<0.5?-1:1, L.bisonSpeed)); }
  for(let i=0;i<CONFIG.rocks;i++){ rocks.push(new Rock(rand(padding, canvas.width-padding), rand(groundY+20, canvas.height-30))); }
  for(let i=0;i<L.stones;i++){ stones.push(new StonePickup(rand(padding, canvas.width-padding), rand(groundY+30, canvas.height-40))); }
  for(let i=0;i<L.woods;i++){ woods.push(new WoodPickup(rand(padding, canvas.width-padding), rand(groundY+30, canvas.height-40))); }
  for(let i=0;i<L.fibers;i++){ fibers.push(new FiberPickup(rand(padding, canvas.width-padding), rand(groundY+30, canvas.height-40))); }

  game = {
    running:false, paused:false, t0:now(),
    player: new Player(canvas.width/2, canvas.height-70),
    herd, rocks, spears, stones, woods, fibers,
    resources:{ meat:0, stone:0, wood:0, fiber:0 },
    time: L.duration, lives:3, lastTime: now(),
    direction:1, coldTick:0, level:L
  };
  ui.levelName.textContent = `${index+1}/3 — ${L.name}`;
  updateHUD();
  drawEverything(0);
}

function start(){ levelIndex=0; initLevel(levelIndex); game.running=true; game.paused=false; loop(); }
function togglePause(){ if(!game) return; game.paused=!game.paused; if(!game.paused){ game.lastTime=now(); loop(); } }

function setDifficulty(){ const map=['Facile','Normal','Difficile']; CONFIG.difficulty=(CONFIG.difficulty+1)%3; ui.easyBtn.textContent='Niveau de difficulté : '+map[CONFIG.difficulty]; if(game) initLevel(levelIndex); }

function craft(){
  if(!game) return;
  const p=game.player, r=game.resources;
  if (p.warm) return;
  if (p.hides>=2 && r.fiber>=2){
    p.warm = true;
    r.fiber -= 2;
    p.hides -= 2;
    game.lives = Math.min(5, game.lives+1); // bonus chaleur = +1 vie
    flashMessage("Vêtements fabriqués : meilleure protection contre le froid !");
    updateHUD();
  } else {
    flashMessage("Il faut 2 peaux et 2 fibres pour coudre des vêtements.");
  }
}

function shoot(){
  if(!game || !game.running || game.paused) return;
  const p=game.player;
  if(p.spears>0){ const dir=game.direction||1; game.spears.push(new Spear(p.x+dir*20, p.y-10, dir)); p.spears--; p.sinceRecharge=0; updateHUD(); }
}

function update(dt){
  const p = game.player;
  const up = keys.has('ArrowUp')||keys.has('KeyW');
  const down = keys.has('ArrowDown')||keys.has('KeyS');
  const left = keys.has('ArrowLeft')||keys.has('KeyA');
  const right = keys.has('ArrowRight')||keys.has('KeyD');
  p.vx = (right?1:0) - (left?1:0); p.vy = (down?1:0) - (up?1:0);
  if (p.vx!==0) game.direction = Math.sign(p.vx);
  p.update(dt*60);

  game.spears.forEach(s=> s.update(dt*60));
  game.herd.forEach(b=> b.update(dt*60));

  // Cold effect (level 1) if no clothes
  if (game.level.cold && !p.warm){
    game.coldTick += dt;
    if (game.coldTick>3){ game.coldTick=0; game.lives--; flashMessage("Froid mordant : fabrique des vêtements !"); if (game.lives<=0){ return end(false); } }
  }

  // spear-bison => meat + hide
  for(const s of game.spears){
    for(const b of game.herd){
      if(!b.tagged && rectHit({x:s.x-6,y:s.y-2,w:12,h:4}, b.rect)){
        b.tagged=true; s.remove=true; game.resources.meat++; p.hides++; // récupère aussi la peau
      }
    }
  }
  // player-bison => damage
  for(const b of game.herd){
    if(!b.tagged && game.player.invincible<=0 && rectHit(b.rect, {x:p.x-p.r,y:p.y-p.r,w:p.r*2,h:p.r*2})){
      game.lives--; p.invincible=2; if (game.lives<=0){ return end(false); }
    }
  }
  // pickups
  for(const st of game.stones){ if(!st.remove && rectHit(st.rect,{x:p.x-p.r,y:p.y-p.r,w:p.r*2,h:p.r*2})) { st.remove=true; game.resources.stone++; } }
  for(const wd of game.woods){ if(!wd.remove && rectHit(wd.rect,{x:p.x-p.r,y:p.y-p.r,w:p.r*2,h:p.r*2})) { wd.remove=true; game.resources.wood++; } }
  for(const fb of game.fibers){ if(!fb.remove && rectHit(fb.rect,{x:p.x-p.r,y:p.y-p.r,w:p.r*2,h:p.r*2})) { fb.remove=true; game.resources.fiber++; } }

  // rocks
  for(const r of game.rocks){ if(rectHit(r.rect,{x:p.x-p.r,y:p.y-p.r,w:p.r*2,h:p.r*2})) { p.x -= p.vx*6; p.y -= p.vy*6; } }

  // cleanup
  game.spears = game.spears.filter(s=>!s.remove);
  game.herd = game.herd.filter(b=>!b.remove);
  game.stones = game.stones.filter(s=>!s.remove);
  game.woods = game.woods.filter(w=>!w.remove);
  game.fibers = game.fibers.filter(f=>!f.remove);

  // timer
  game.time -= dt;
  if (game.time<=0){ end(true); }

  updateHUD();
}

function end(timeUp){
  game.running=false;
  const g = game.level.goals, r = game.resources;
  const need = [];
  if (r.meat < g.meat) need.push("nourriture");
  if (r.stone < g.stone) need.push("pierre (outils)");
  if (r.wood < g.wood) need.push("bois (feu/abri)");
  if (g.craft && !game.player.warm) need.push("vêtements");
  const ok = need.length===0;
  let title = ok? "Objectif atteint" : "Bilan – ce qui manque";
  let body = ok? `Tu peux passer à l'étape suivante : ${levelIndex<LEVELS.length-1? 'on s'+"'"+'installe près de l'eau et on développe l'artisanat.' : 'installation durable : villages et champs.'}`
               : `Il manque : ${need.join(', ')}.`;
  overlay(title, body + "\nConseil : observe l'environnement et priorise selon les besoins du groupe.");
}

function nextLevel(){
  if (levelIndex < LEVELS.length-1){ levelIndex++; initLevel(levelIndex); game.running=true; game.paused=false; }
  else { overlay("Parcours terminé","De la chasse au camp sédentaire : tu as traversé la révolution néolithique."); }
}

function drawEverything(t){
  const L = game.level;
  L.drawBG(ctx, canvas.width, canvas.height, t);
  // ground strip
  ctx.fillStyle = '#86c06a'; ctx.fillRect(0,260,canvas.width,280);
  // set different ground per level
  if (levelIndex===0){ ctx.fillStyle='#a7c7df'; ctx.fillRect(0,260,canvas.width,280); } // neige bleutée
  if (levelIndex===1){ ctx.fillStyle='#7cc38e'; ctx.fillRect(0,260,canvas.width,280); } // prairie lacustre
  if (levelIndex===2){ ctx.fillStyle='#cbbf8c'; ctx.fillRect(0,260,canvas.width,280); } // sol blond champs
  // items
  game.rocks.forEach(r=> r.draw());
  game.stones.forEach(s=> s.draw());
  game.woods.forEach(w=> w.draw());
  game.fibers.forEach(f=> f.draw());
  game.herd.forEach(b=> b.draw());
  game.player.draw();
  game.spears.forEach(s=> s.draw());
}

function loop(){
  if (!game || !game.running) return;
  const t = now();
  if (!game.paused){
    const dt = (t - game.lastTime)/1000;
    update(dt);
    drawEverything(t - game.t0);
    game.lastTime = t;
    requestAnimationFrame(loop);
  }
}

function updateHUD(){
  if (!game) return;
  ui.time.textContent = Math.max(0, Math.ceil(game.time));
  ui.meat.textContent = game.resources.meat;
  ui.stone.textContent = game.resources.stone;
  ui.wood.textContent = game.resources.wood;
  ui.fiber.textContent = game.resources.fiber;
  ui.spears.textContent = game.player.spears;
  ui.lives.textContent = game.lives;
}

function rectHit(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

function roundRect(x,y,w,h,r,mode){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  if(mode==='fill') ctx.fill();
  else ctx.stroke();
}

// ===== Background painters (more elaborate)
function drawCloud(ctx,x,y,scale){
  ctx.save(); ctx.translate(x,y); ctx.scale(scale,scale);
  ctx.fillStyle='rgba(255,255,255,.9)';
  ctx.beginPath(); ctx.arc(0,0,18,0,Math.PI*2); ctx.arc(16,4,14,0,Math.PI*2); ctx.arc(-16,6,12,0,Math.PI*2); ctx.fill();
  ctx.restore();
}
function drawAlpine(ctx,w,h,t){
  ctx.fillStyle = '#a4d2ff'; ctx.fillRect(0,0,w,240);
  for(let i=0;i<6;i++){ drawCloud(ctx,(t*0.03 + i*180)% (w+200)-100, 60+ (i%2)*20, 1+(i%3)*0.1); }
  ctx.fillStyle='#7aa3c8';
  ctx.beginPath(); ctx.moveTo(0,220);
  for(let x=0;x<=w;x+=60){ const peak = 220 - 50 - 40*Math.sin((x+t*0.0008)*0.01); ctx.lineTo(x,peak); }
  ctx.lineTo(w,220); ctx.closePath(); ctx.fill();
  // glaciers
  ctx.fillStyle='#e7f2fb'; ctx.fillRect(0,240,w,24);
}
function drawLakeside(ctx,w,h,t){
  ctx.fillStyle = '#bfe3ff'; ctx.fillRect(0,0,w,220);
  for(let i=0;i<5;i++){ drawCloud(ctx,(t*0.04 + i*220)% (w+220)-110, 70+ (i%2)*26, 1.1); }
  // arbres
  for(let i=0;i<10;i++){ const x=(i*100+ (w*0.1))%w; ctx.fillStyle='#316b3f'; ctx.fillRect(x,200,16,40); ctx.beginPath(); ctx.fillStyle='#4aa26c'; ctx.arc(x+8,190,26,0,Math.PI*2); ctx.fill(); }
  // lac
  ctx.fillStyle='#5bb6f5'; ctx.fillRect(0,240,w,32);
}
function drawFertileCrescent(ctx,w,h,t){
  ctx.fillStyle = '#f5e6b2'; ctx.fillRect(0,0,w,220);
  // soleil
  ctx.fillStyle='#ffd166'; ctx.beginPath(); ctx.arc(90,70,24,0,Math.PI*2); ctx.fill();
  // champs en bandes
  for(let i=0;i<6;i++){ ctx.fillStyle = i%2? '#b4d97a' : '#d6c877'; ctx.fillRect(i*(w/6),220-20, w/6, 20); }
  // huttes
  for(let i=0;i<4;i++){ const x=140+i*180; ctx.fillStyle='#c89b6d'; roundRect(x,185,44,28,6,'fill'); ctx.fillStyle='#8b5a3c'; ctx.beginPath(); ctx.moveTo(x,185); ctx.lineTo(x+22,168); ctx.lineTo(x+44,185); ctx.closePath(); ctx.fill(); }
  // irrigation (canal)
  ctx.fillStyle='#5bb6f5'; ctx.fillRect(0,240,w,14);
}

// ===== UI
ui.startBtn.addEventListener('click', ()=>{ start(); overlay("Niveau 1","Montagnes glaciaires : chasse, collecte, protège-toi du froid."); });
ui.pauseBtn.addEventListener('click', togglePause);
ui.easyBtn.addEventListener('click', ()=>{ setDifficulty(); });
ui.craftBtn.addEventListener('click', craft);

// Overlay & messages
function overlay(title, text){
  ctx.save(); ctx.fillStyle='rgba(0,0,0,.58)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='white'; ctx.textAlign='center';
  ctx.font='bold 34px system-ui'; ctx.fillText(title, canvas.width/2, canvas.height/2 - 30);
  ctx.font='16px system-ui'; const lines = (text||'').split('\n'); lines.forEach((ln,i)=> ctx.fillText(ln, canvas.width/2, canvas.height/2 + i*22));
  ctx.font='14px system-ui'; ctx.fillText('Espace = javelot • C = fabriquer vêtements • Lancer/Rejouer pour continuer', canvas.width/2, canvas.height/2 + 22*lines.length + 28);
  ctx.restore();
}
let flash=0, flashText='';
function flashMessage(txt){ flash=1.8; flashText=txt; }

// Advance to next level on click when finished OK
canvas.addEventListener('click', ()=>{ if(game && !game.running) nextLevel(); });

// Start initial screen
overlay("Ötzi – Des glaces aux villages","Récupère nourriture, pierre, bois et fibres.\nFabrique des vêtements pour survivre au froid.\nTraverse les 3 étapes jusqu'à la sédentarisation.");

// Resize handling
const resize = ()=>{ const rect = canvas.getBoundingClientRect(); const ratio = window.devicePixelRatio || 1; canvas.width = Math.round(rect.width*ratio); canvas.height = Math.round(rect.height*ratio); if(game) drawEverything(0); };
new ResizeObserver(resize).observe(canvas);

// Draw flash message
const _fillText = (text,x,y)=>ctx.fillText(text,x,y);
function drawFlash(){
  if(flash>0){
    flash -= 0.03;
    ctx.save(); ctx.globalAlpha = Math.max(0, Math.min(1, flash)); ctx.fillStyle='rgba(0,0,0,.6)';
    roundRect(canvas.width/2-260, 24, 520, 36, 8, 'fill');
    ctx.fillStyle='white'; ctx.textAlign='center'; ctx.font='bold 16px system-ui';
    _fillText(flashText, canvas.width/2, 48);
    ctx.restore();
  }
}

(function patchLoop(){
  const _req = window.requestAnimationFrame;
  window.requestAnimationFrame = function(fn){
    return _req(function(t){ fn(t); drawFlash(); });
  }
})();

</script>
</body>
</html>
