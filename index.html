<!doctype html>
<html lang="fr">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ötzi — version pare-balles</title>
<style>
  html,body{margin:0;height:100%;background:#0e141b;color:#e8eef6;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px}
  canvas{background:#93c5fd;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);
         width:min(980px,95vw);height:calc(min(980px,95vw)*0.56);image-rendering:pixelated;outline:none}
  .hud{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;font-weight:600}
  .kbd{padding:2px 6px;border-radius:6px;background:#223049;font-family:ui-monospace,Menlo,Consolas,monospace}
  button{padding:10px 14px;border-radius:10px;border:0;background:#1f6feb;color:#fff;font-weight:700;cursor:pointer}
  .pill{padding:3px 8px;border-radius:999px;background:#0b5;color:#fff;font-weight:700;font-size:12px}
</style>

<div class="wrap">
  <h1>Ötzi — Des glaces aux villages</h1>
  <div class="hud">
    <span>Niveau: <b id="levelName">—</b></span>
    <span>Temps: <b id="time">—</b>s</span>
    <span>Nourriture: <b id="meat">0</b></span>
    <span>Pierre: <b id="stone">0</b></span>
    <span>Bois: <b id="wood">0</b></span>
    <span>Fibres: <b id="fiber">0</b></span>
    <span>Argile: <b id="clay">0</b></span>
    <span>Bétail: <b id="livestock">0</b></span>
    <span>Objets: <b id="crafted">0</b></span>
    <span>Javelots: <b id="spears">3</b></span>
    <span>Vies: <b id="lives">3</b></span>
    <button id="start">Lancer / Rejouer</button>
    <button id="pause">Pause</button>
  </div>
  <div>Commandes : <span class="kbd">← → ↑ ↓</span> / <span class="kbd">W A S D</span> • <span class="kbd">Espace</span> javelot • <span class="kbd">C</span> vêtements • <span class="kbd">F</span> fabriquer • <span class="kbd">Entrée</span> narration</div>
  <canvas id="game" width="960" height="540" tabindex="0" aria-label="Jeu pédagogique Néolithique"></canvas>
  <div style="max-width:min(980px,95vw);text-align:center">
    Étapes : <span class="pill">1. Chasse</span> → <span class="pill">2. Élevage</span> → <span class="pill">3. Artisanat</span> → <span class="pill">4. Agriculture</span>
  </div>
</div>

<script>
/* ====== Sécurité & diag visuel ====== */
['keydown','keypress'].forEach(t=>document.addEventListener(t,e=>{
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space','Enter'].includes(e.code)) e.preventDefault();
},{passive:false}));

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const ui = id=>document.getElementById(id);
const HUD = { levelName:ui('levelName'), time:ui('time'), meat:ui('meat'), stone:ui('stone'), wood:ui('wood'), fiber:ui('fiber'), clay:ui('clay'),
              livestock:ui('livestock'), crafted:ui('crafted'), spears:ui('spears'), lives:ui('lives') };
const btnStart = document.getElementById('start'), btnPause = document.getElementById('pause');

let running=false, last=performance.now(), keys=new Set();
function resize(){ const r=canvas.getBoundingClientRect(), dpr=window.devicePixelRatio||1; canvas.width=Math.round(r.width*dpr); canvas.height=Math.round(r.height*dpr); }
new ResizeObserver(resize).observe(canvas); resize();

/* ====== Catch d’erreurs pour afficher à l’écran ====== */
function showError(where, message){
  ctx.fillStyle='rgba(0,0,0,.7)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.font='bold 26px system-ui';
  ctx.fillText('Erreur JS – ' + where, canvas.width/2, canvas.height/2 - 40);
  ctx.font='14px ui-monospace,monospace';
  const lines=(message+'').split('\n').slice(0,8);
  lines.forEach((ln,i)=>ctx.fillText(ln, canvas.width/2, canvas.height/2 + i*18));
}
window.onerror = function(msg, src, line, col, err){
  showError('onerror', (msg||'') + '\\n' + (err && err.stack ? err.stack : (src+':'+line)));
  return true;
};

/* ====== Mini décor + panneau “JS OK” au boot ====== */
function drawBG(t){
  ctx.fillStyle='#a4d2ff'; ctx.fillRect(0,0,canvas.width,240);
  ctx.fillStyle='#7aa3c8'; ctx.beginPath(); ctx.moveTo(0,220);
  for(let x=0;x<=canvas.width;x+=60){ const peak=220-50-40*Math.sin((x+t*0.0008)*0.01); ctx.lineTo(x,peak); }
  ctx.lineTo(canvas.width,220); ctx.closePath(); ctx.fill();
  ctx.fillStyle='#86c06a'; ctx.fillRect(0,240,canvas.width,canvas.height-240);
}
function rr(x,y,w,h,r,fill){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); fill?ctx.fill():ctx.stroke(); }
function introPanel(){
  drawBG(performance.now());
  ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  rr(canvas.width/2-360, canvas.height/2-130, 720, 200, 14, true);
  ctx.fillStyle='#fff'; ctx.textAlign='center';
  ctx.font='bold 28px system-ui'; ctx.fillText('JS OK — appuie sur Entrée ou clique', canvas.width/2, canvas.height/2-70);
  ctx.font='16px system-ui';
  ctx.fillText('Si cet écran apparaît, le JavaScript tourne bien sur GitHub Pages.', canvas.width/2, canvas.height/2-25);
}

/* ====== Jeu minimal mais complet (mouvements + ressources) ====== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
let player={x:200,y:380,r:16,vx:0,vy:0,speed:2.5,spears:3,reload:0,hides:0,warm:false};
let pickups=[], time=60, lives=3;
function drawPlayer(){ ctx.save(); ctx.translate(player.x,player.y);
  ctx.globalAlpha=.25; ctx.beginPath(); ctx.ellipse(0,player.r,player.r*.9,player.r*.4,0,0,Math.PI*2); ctx.fillStyle='#1b2a3b'; ctx.fill(); ctx.globalAlpha=1;
  ctx.beginPath(); ctx.moveTo(0,-player.r); ctx.lineTo(player.r*.9,player.r); ctx.lineTo(-player.r*.9,player.r); ctx.closePath(); ctx.fillStyle='#7a5230'; ctx.fill();
  ctx.beginPath(); ctx.arc(0,-player.r*1.2,player.r*.55,0,Math.PI*2); ctx.fillStyle='#d7b49e'; ctx.fill(); ctx.restore(); }
function spawnPickup(){ return {x:Math.random()*(canvas.width-60)+30,y:Math.random()*(canvas.height-280)+260}; }
function hit(p,pl){ const dx=p.x-pl.x, dy=p.y-pl.y; return Math.hypot(dx,dy) < pl.r+10; }
function updateHUD(){ HUD.time.textContent=Math.max(0,Math.ceil(time)); HUD.spears.textContent=player.spears; HUD.lives.textContent=lives; }

function startGame(){ running=true; last=performance.now(); requestAnimationFrame(gameLoop); }
function gameLoop(t){
  try{
    if(!running) return;
    const dt=(t-last)/16.67; last=t;
    // input
    const up=keys.has('ArrowUp')||keys.has('KeyW'), dn=keys.has('ArrowDown')||keys.has('KeyS'),
          lf=keys.has('ArrowLeft')||keys.has('KeyA'), rg=keys.has('ArrowRight')||keys.has('KeyD');
    player.vx=(rg?1:0)-(lf?1:0); player.vy=(dn?1:0)-(up?1:0);
    player.x=clamp(player.x+player.vx*player.speed*dt, player.r, canvas.width-player.r);
    player.y=clamp(player.y+player.vy*player.speed*dt, 220, canvas.height-player.r);

    // spawns simples
    if(Math.random()<0.02) pickups.push(spawnPickup());
    pickups.forEach(p=>{ if(!p.gone && hit(p,player)){ p.gone=true; HUD.stone.textContent = (+HUD.stone.textContent)+1; } });
    pickups = pickups.filter(p=>!p.gone);

    // time
    time -= dt/60; if(time<=0){ running=false; overlay('Fin du test','Clique “Lancer / Rejouer”.'); return; }
    // draw
    drawBG(t);
    pickups.forEach(p=>{ ctx.save(); ctx.translate(p.x,p.y); ctx.fillStyle='#9aa4a9'; ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill(); ctx.restore(); });
    drawPlayer(); updateHUD();
    requestAnimationFrame(gameLoop);
  }catch(err){ showError('loop', err.stack||err.message); }
}
function overlay(title,text){ ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.font='bold 32px system-ui'; ctx.fillText(title,canvas.width/2,canvas.height/2-20);
  ctx.font='16px system-ui'; ctx.fillText(text||'',canvas.width/2,canvas.height/2+10); }

/* ====== Entrées ====== */
document.addEventListener('keydown', e=>{
  if(['ArrowUp','KeyW','ArrowDown','KeyS','ArrowLeft','KeyA','ArrowRight','KeyD'].includes(e.code)) keys.add(e.code);
  if(e.code==='Enter' && !running) startGame();
});
document.addEventListener('keyup', e=> keys.delete(e.code));
document.addEventListener('click', ()=>{ if(!running) startGame(); });
btnStart.addEventListener('click', ()=>{ time=60; pickups=[]; startGame(); });
btnPause.addEventListener('click', ()=>{ running=!running; if(running){ last=performance.now(); requestAnimationFrame(gameLoop); } });

/* ====== Boot : toujours dessiner quelque chose ====== */
function boot(){
  drawBG(performance.now());
  // “JS OK” visible même si le jeu n’a pas démarré
  ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(16,16,200,70);
  ctx.fillStyle='#10b981'; ctx.font='bold 20px system-ui'; ctx.fillText('JS OK', 28, 48);
  ctx.fillStyle='#fff'; ctx.font='12px ui-monospace,monospace'; ctx.fillText('Build Pages OK', 28, 68);
  introPanel();
  updateHUD();
}
if (document.readyState==='complete' || document.readyState==='interactive') boot();
else window.addEventListener('DOMContentLoaded', boot);
</script>
</html>
